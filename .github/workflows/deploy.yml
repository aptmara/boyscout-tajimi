# GitHub Actions: ConoHa VPSã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«VPSã¸è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
# - è©³ç´°ãƒ­ã‚°å‡ºåŠ›
# - å¤±æ•—æ™‚ã®Discordé€šçŸ¥
# - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

name: Deploy to ConoHa VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DEPLOY_PATH: /var/www/boyscout-tajimi
  APP_NAME: boyscout-tajimi
  SITE_URL: https://www.tajimibs.org

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ”‘ SSHã‚­ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        id: ssh_setup
        run: |
          set -e
          echo "::group::SSHè¨­å®š"
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY_BASE64 }}" | tr -d '\r\n ' | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
          echo "âœ… SSHã‚­ãƒ¼è¨­å®šå®Œäº†"
          echo "::endgroup::"

      - name: ğŸš€ VPSã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            deploy@${{ secrets.VPS_HOST }} << 'ENDSSH'
              set -e
              
              echo "=========================================="
              echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹: $(date '+%Y-%m-%d %H:%M:%S')"
              echo "=========================================="
              
              cd /var/www/boyscout-tajimi
              
              # Step 1: Git fetch
              echo ""
              echo "ğŸ“¦ [1/5] æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ä¸­..."
              git fetch origin main
              CURRENT_COMMIT=$(git rev-parse --short HEAD)
              git reset --hard origin/main
              NEW_COMMIT=$(git rev-parse --short HEAD)
              echo "   âœ… æ›´æ–°å®Œäº†: $CURRENT_COMMIT â†’ $NEW_COMMIT"
              
              # Step 2: npm install
              echo ""
              echo "ğŸ“¦ [2/5] ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
              npm ci --omit=dev 2>&1 | tail -5
              echo "   âœ… npm ci å®Œäº†"
              
              # Step 3: Build
              echo ""
              echo "ğŸ”¨ [3/5] ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
              npm run build 2>&1 | tail -10
              echo "   âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"
              
              # Step 4: PM2 restart
              echo ""
              echo "ğŸ”„ [4/5] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•ä¸­..."
              pm2 restart boyscout-tajimi --update-env
              sleep 3
              pm2 status boyscout-tajimi
              echo "   âœ… PM2å†èµ·å‹•å®Œäº†"
              
              # Step 5: Health check
              echo ""
              echo "ğŸ¥ [5/5] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
              # èµ·å‹•å¾…æ©Ÿ
              sleep 5
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/ --max-time 10 || echo "000")
              
              if [ "$HTTP_STATUS" = "200" ]; then
                echo "   âœ… ã‚µãƒ¼ãƒãƒ¼å¿œç­”OK (HTTP $HTTP_STATUS)"
                echo "   âŒ ã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚¨ãƒ©ãƒ¼: HTTP $HTTP_STATUS"
                echo "::group::ğŸ“Š ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚° (ç›´è¿‘50è¡Œ)"
                echo "--- Error Log ---"
                pm2 logs boyscout-tajimi --lines 50 --err --nostream
                echo ""
                echo "--- Output Log ---"
                pm2 logs boyscout-tajimi --lines 50 --out --nostream
                echo "::endgroup::"
                exit 1
              fi
              
              DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
              echo ""
              echo "=========================================="
              echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $DEPLOY_TIME"
              echo "   ã‚³ãƒŸãƒƒãƒˆ: $NEW_COMMIT"
              echo "=========================================="
              
              # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å‡ºåŠ›ï¼ˆå¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
              echo "DEPLOY_TIME=$DEPLOY_TIME" >> /tmp/deploy_env
              echo "NEW_COMMIT=$NEW_COMMIT" >> /tmp/deploy_env
          ENDSSH

      - name: âœ… æˆåŠŸé€šçŸ¥ (Discord)
        if: success()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          ACTOR="${{ github.actor }}"
          
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ\",
                \"description\": \"**${{ env.APP_NAME }}** ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ\",
                \"color\": 5763719,
                \"fields\": [
                  {\"name\": \"ã‚³ãƒŸãƒƒãƒˆ\", \"value\": \"[\`${COMMIT_SHORT}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})\", \"inline\": true},
                  {\"name\": \"å®Ÿè¡Œè€…\", \"value\": \"${ACTOR}\", \"inline\": true},
                  {\"name\": \"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\", \"value\": \"${COMMIT_MSG:0:100}\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"GitHub Actions\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" || true

      - name: âŒ å¤±æ•—é€šçŸ¥ (Discord)
        if: failure()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          ACTOR="${{ github.actor }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—\",
                \"description\": \"**${{ env.APP_NAME }}** ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"ã‚³ãƒŸãƒƒãƒˆ\", \"value\": \"[\`${COMMIT_SHORT}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})\", \"inline\": true},
                  {\"name\": \"å®Ÿè¡Œè€…\", \"value\": \"${ACTOR}\", \"inline\": true},
                  {\"name\": \"ãƒ­ã‚°\", \"value\": \"[Actions ãƒ­ã‚°ã‚’ç¢ºèª](${RUN_URL})\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"GitHub Actions\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" || true

      - name: ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: rm -f ~/.ssh/deploy_key
