<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動の作成/編集</title>
  <link rel="stylesheet" href="admin-styles.css">
  <script src="admin-ui.js"></script>
</head>
<body>
  <div class="container">
    <h1 id="page-title">活動の新規作成</h1>
    <form id="edit-form">
      <input type="hidden" id="activity-id" name="id">

      <div class="form-group">
        <label for="title">タイトル</label>
        <input type="text" id="title" name="title" required>
      </div>

      <div class="form-group">
        <label for="content">本文</label>
        <textarea id="content" name="content" required></textarea>
      </div>

      <div class="form-group">
        <label for="category">カテゴリー</label>
        <input type="text" id="category" name="category" placeholder="例: 活動報告">
      </div>

      <label class="block text-sm font-medium text-gray-700 mt-4">隊</label>
      <select id="unit" class="mt-1 block w-full border rounded p-2"></select>

      <label class="block text-sm font-medium text-gray-700 mt-4">タグ</label>
      <select id="tags" class="mt-1 block w-full border rounded p-2" multiple size="6"></select>

      <div class="form-group">
        <label for="activity_date">活動日</label>
        <input type="date" id="activity_date" name="activity_date">
      </div>

      <div class="form-group">
        <label for="images">画像URL（改行区切り）</label>
        <textarea id="images" name="images" placeholder="https://...\nhttps://..."></textarea>
      </div>

      <div class="form-actions" style="display:flex; gap:10px; align-items:center;">
        <button type="submit">保存</button>
        <a href="/admin/settings.html?tab=activity"><button type="button" class="btn-ghost">キャンセル</button></a>
      </div>
      <p id="error-message" class="error-message"></p>
    </form>
  </div>

  <script>
    function parseJsonSafe(s, f){ try { return JSON.parse(s); } catch { return f; } }
    function normalizeSlug(s){ return String(s||'').trim().toLowerCase(); }
    let settingsCache = null;

    async function ensureLoggedIn(){
      try { const r = await fetch('/api/session', { credentials: 'same-origin' }); const d = await r.json(); if (!d.loggedIn) location.href='/admin/login.html'; }
      catch { location.href='/admin/login.html'; }
    }

    async function loadSettings(){
      try {
        const r = await fetch('/api/settings/all', { credentials: 'same-origin' });
        if (!r.ok) { let msg = '保存に失敗しました'; try { const data = await r.json(); if (data && (data.error||data.detail)) msg = data.error || data.detail; } catch {} throw new Error(msg); }
        const rows = await r.json();
        settingsCache = rows.reduce((acc, it) => (acc[it.key]=it.value, acc), {});
      } catch { settingsCache = {}; }
    }

    function fillUnitAndTags({ currentUnit = '', currentTags = [] } = {}){
      const unitSel = document.getElementById('unit');
      const tagsSel = document.getElementById('tags');
      const units = parseJsonSafe(settingsCache?.units_json || '[]', []);
      const tags  = parseJsonSafe(settingsCache?.activity_tags_json || '[]', []);
      // unit
      unitSel.innerHTML = '';
      const empty = document.createElement('option'); empty.value=''; empty.textContent='（未選択）'; unitSel.appendChild(empty);
      for (const u of units){
        const opt = document.createElement('option'); opt.value = u.slug; opt.textContent = u.label || u.slug;
        if (normalizeSlug(currentUnit) === normalizeSlug(u.slug)) opt.selected = true;
        unitSel.appendChild(opt);
      }
      // tags
      tagsSel.innerHTML = '';
      const cur = new Set(Array.isArray(currentTags)?currentTags.map(normalizeSlug):[]);
      for (const t of tags){
        const opt = document.createElement('option'); opt.value = t.slug; opt.textContent = t.label || t.slug;
        if (cur.has(normalizeSlug(t.slug))) opt.selected = true;
        tagsSel.appendChild(opt);
      }
    }

    async function loadActivityIfEdit(){
      const p = new URLSearchParams(location.search);
      const id = p.get('id');
      const titleEl = document.getElementById('page-title');
      if (!id) return null;
      titleEl.textContent = '活動の編集';
      document.getElementById('activity-id').value = id;
      try {
        const r = await fetch(`/api/activities/${id}`, { credentials: 'same-origin' });
        if (!r.ok) { let msg = '保存に失敗しました'; try { const data = await r.json(); if (data && (data.error||data.detail)) msg = data.error || data.detail; } catch {} throw new Error(msg); }
        const a = await r.json();
        document.getElementById('title').value = a.title || '';
        document.getElementById('content').value = a.content || '';
        document.getElementById('category').value = a.category || '';
        document.getElementById('activity_date').value = a.activity_date ? String(a.activity_date).slice(0,10) : '';
        const imgs = Array.isArray(a.image_urls) ? a.image_urls : [];
        document.getElementById('images').value = imgs.join('\n');
        // unit & tags will be set by fillUnitAndTags once settings loaded, pass current values
        return { unit: a.unit || '', tags: Array.isArray(a.tags)?a.tags:[] };
      } catch { return null; }
    }

    function collectForm(){
      const images = String(document.getElementById('images').value || '')
        .split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const tags = Array.from(document.getElementById('tags').options).filter(o=>o.selected).map(o=>o.value);
      const payload = {
        title: String(document.getElementById('title').value || '').trim(),
        content: String(document.getElementById('content').value || '').trim(),
        category: String(document.getElementById('category').value || '').trim() || null,
        unit: String(document.getElementById('unit').value || '').trim() || null,
        activity_date: (document.getElementById('activity_date').value || '') || null,
        images,
        tags,
      };
      return payload;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await ensureLoggedIn();
      const editState = await loadActivityIfEdit();
      await loadSettings();
      fillUnitAndTags({ currentUnit: editState?.unit, currentTags: editState?.tags });

      const form = document.getElementById('edit-form');
      const errorEl = document.getElementById('error-message');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorEl.textContent = '';
        const payload = collectForm();
        if (!payload.title || !payload.content){ errorEl.textContent = 'タイトルと本文は必須です'; return; }
        const id = document.getElementById('activity-id').value;
        const url = id ? `/api/activities/${id}` : '/api/activities';
        const method = id ? 'PUT' : 'POST';
        try {
          const r = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(payload) });
          if (!r.ok) { let msg = '保存に失敗しました'; try { const data = await r.json(); if (data && (data.error||data.detail)) msg = data.error || data.detail; } catch {} throw new Error(msg); }
          AdminUI.showResult({
            ok: true,
            message: '活動を保存しました',
            actions: [
              { label: '一覧へ戻る', variant: 'primary', onClick: ()=> { location.href = '/admin/settings.html?tab=activity'; } },
              { label: 'このまま続ける', variant: 'ghost' }
            ]
          });
        } catch (e) {
          errorEl.textContent = e.message || 'エラーが発生しました';
          AdminUI.showResult({ ok:false, message: '活動の保存に失敗しました', detail: e.message });
        }
      });
    });
  </script>
</body>
</html>

