// admin-app.js (UTF-8)
(function(){
  const routes = {
    news:         { title: '„ÅäÁü•„Çâ„ÅõÁÆ°ÁêÜ',     src: '/admin/dashboard.html' },
    activities:   { title: 'Ê¥ªÂãïÁÆ°ÁêÜ',         src: '/admin/settings.html?tab=activity' },
    settings:     { title: '„Çµ„Ç§„ÉàË®≠ÂÆö',       src: '/admin/settings.html' },
    branding:     { title: '„Éñ„É©„É≥„Éá„Ç£„É≥„Ç∞',   src: '/admin/branding.html' },
    news_new:     { title: '„ÅäÁü•„Çâ„Åõ Êñ∞Ë¶è‰ΩúÊàê', src: '/admin/edit.html' },
    activity_new: { title: 'Ê¥ªÂãï Êñ∞Ë¶è‰ΩúÊàê',     src: '/admin/activity-edit.html' },
  };

  async function ensureSession(){
    try {
      const r = await fetch('/api/session', { credentials: 'same-origin' });
      const d = await r.json();
      if (!d.loggedIn) location.replace('/admin/login.html');
    } catch {
      location.replace('/admin/login.html');
    }
  }

  function setActive(key){
    const iframe = document.getElementById('main-frame');
    const titleEl = document.getElementById('view-title');
    const btns = document.querySelectorAll('[data-nav]');
    btns.forEach(b => b.classList.toggle('active', b.dataset.nav === key));
    const route = routes[key] || routes.news;
    if (titleEl) titleEl.textContent = route.title;
    if (iframe && iframe.src !== route.src) iframe.src = route.src;
    localStorage.setItem('admin.active', key);
    document.querySelector('.app-nav')?.classList.remove('open');
  }

  function initZoom(){
    const root = document.documentElement;
    const get = ()=> Number(localStorage.getItem('admin.zoom') || '1');
    const set = (v)=> { v = Math.min(1.25, Math.max(0.9, Number(v)||1)); localStorage.setItem('admin.zoom', String(v)); root.style.setProperty('--zoom', v); };
    set(get());
    document.getElementById('zoom-inc')?.addEventListener('click', ()=> set(get() + 0.05));
    document.getElementById('zoom-dec')?.addEventListener('click', ()=> set(get() - 0.05));
  }

  function initNav(){
    document.querySelector('.links')?.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-nav]');
      if (!btn) return;
      setActive(btn.dataset.nav);
    });
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      try { await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' }); location.replace('/admin/login.html'); }
      catch { alert('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); }
    });
    document.getElementById('menu-toggle')?.addEventListener('click', ()=>{
      document.querySelector('.app-nav')?.classList.toggle('open');
    });
    document.getElementById('quick-new-news')?.addEventListener('click', ()=> setActive('news_new'));
    document.getElementById('quick-new-activity')?.addEventListener('click', ()=> setActive('activity_new'));
  }

  // „Ç≥„Éû„É≥„Éâ„Éë„É¨„ÉÉ„ÉàÔºàCtrl/Cmd + KÔºâ
  const palette = { backdrop:null, input:null, list:null, open:false, items:[], sel:-1 };

  function showPalette(q=''){
    palette.backdrop.classList.add('open');
    palette.open = true; palette.input.value = q; palette.input.focus();
    renderPalette();
  }
  function hidePalette(){ palette.backdrop.classList.remove('open'); palette.open = false; palette.sel = -1; }

  function paletteItemEl(item, i){
    const el = document.createElement('div');
    el.className = 'cmdp-item' + (i===palette.sel?' active':'');
    el.role = 'option'; el.dataset.index = String(i);
    el.innerHTML = `<div>${item.icon||''}</div><div><div>${item.label}</div><div class="sub">${item.sub||''}</div></div>`;
    el.addEventListener('click', ()=> execItem(item));
    return el;
  }

  function renderPalette(){
    const q = (palette.input.value || '').toLowerCase();
    const filtered = palette.items.filter(it => (it.label+ ' ' + (it.sub||'')).toLowerCase().includes(q));
    const list = palette.list; list.innerHTML = '';
    filtered.forEach((it, i)=> list.appendChild(paletteItemEl(it, i)));
    palette.sel = filtered.length ? 0 : -1;
  }

  function execItem(item){
    if (!item) return;
    hidePalette();
    if (item.type === 'route'){ setActive(item.key); return; }
    if (item.type === 'open'){
      const iframe = document.getElementById('main-frame');
      const titleEl = document.getElementById('view-title');
      if (titleEl) titleEl.textContent = item.title || item.label;
      if (iframe) iframe.src = item.href;
      return;
    }
  }

  async function loadIndexData(){
    try {
      const [newsRes, actRes] = await Promise.all([
        fetch('/api/news', { credentials: 'same-origin' }),
        fetch('/api/activities', { credentials: 'same-origin' })
      ]);
      const [news, acts] = await Promise.all([newsRes.json(), actRes.json()]);
      const newsItems = (Array.isArray(news)?news:[]).slice(0,200).map(n=>({
        type: 'open', icon: 'üì∞', label: n.title||'(ÁÑ°È°å)', sub: '„ÅäÁü•„Çâ„Åõ', href: `/admin/edit.html?id=${n.id}`, title: '„ÅäÁü•„Çâ„Åõ„ÅÆÁ∑®ÈõÜ'
      }));
      const actItems = (Array.isArray(acts)?acts:[]).slice(0,200).map(a=>({
        type: 'open', icon: 'üß≠', label: a.title||'(ÁÑ°È°å)', sub: 'Ê¥ªÂãï', href: `/admin/activity-edit.html?id=${a.id}`, title: 'Ê¥ªÂãï„ÅÆÁ∑®ÈõÜ'
      }));
      return { newsItems, actItems };
    } catch {
      return { newsItems: [], actItems: [] };
    }
  }

  async function initPalette(){
    palette.backdrop = document.getElementById('cmdp-backdrop');
    palette.input = document.getElementById('cmdp-input');
    palette.list = document.getElementById('cmdp-list');

    // „Éô„Éº„Çπ„ÅÆ„Ç≥„Éû„É≥„Éâ
    const base = [
      { type:'route', key:'news',        icon:'üì∞', label:'„ÅäÁü•„Çâ„Åõ‰∏ÄË¶ß„ÇíÈñã„Åè' },
      { type:'route', key:'activities',  icon:'üß≠', label:'Ê¥ªÂãï‰∏ÄË¶ß„ÇíÈñã„Åè' },
      { type:'route', key:'settings',    icon:'‚öôÔ∏è', label:'„Çµ„Ç§„ÉàË®≠ÂÆö„ÇíÈñã„Åè' },
      { type:'route', key:'branding',    icon:'üé®', label:'„Éñ„É©„É≥„Éá„Ç£„É≥„Ç∞„ÇíÈñã„Åè' },
      { type:'route', key:'news_new',    icon:'‚ûï', label:'„ÅäÁü•„Çâ„Åõ„ÇíÊñ∞Ë¶è‰ΩúÊàê' },
      { type:'route', key:'activity_new',icon:'‚ûï', label:'Ê¥ªÂãï„ÇíÊñ∞Ë¶è‰ΩúÊàê' },
    ];

    const { newsItems, actItems } = await loadIndexData();
    palette.items = [...base, ...newsItems, ...actItems];

    // ÂÖ•Âäõ„Ç§„Éô„É≥„Éà
    palette.input.addEventListener('input', renderPalette);
    palette.backdrop.addEventListener('click', (e)=>{ if (e.target === palette.backdrop) hidePalette(); });
    document.addEventListener('keydown', (e)=>{
      const mod = (e.ctrlKey || e.metaKey);
      if (mod && e.key.toLowerCase() === 'k'){ e.preventDefault(); showPalette(''); return; }
      if (!palette.open) return;
      if (e.key === 'Escape'){ hidePalette(); return; }
      const listItems = Array.from(palette.list.querySelectorAll('.cmdp-item'));
      if (['ArrowDown','ArrowUp','Enter'].includes(e.key)) e.preventDefault();
      if (e.key === 'ArrowDown'){ palette.sel = Math.min(listItems.length-1, (palette.sel<0?0:palette.sel+1)); highlight(listItems); }
      if (e.key === 'ArrowUp'){ palette.sel = Math.max(0, (palette.sel-1)); highlight(listItems); }
      if (e.key === 'Enter'){
        const visible = palette.items.filter(it => (it.label+' '+(it.sub||'')).toLowerCase().includes((palette.input.value||'').toLowerCase()));
        const item = visible[palette.sel];
        execItem(item);
      }
    });

    function highlight(nodes){ nodes.forEach((n,i)=> n.classList.toggle('active', i===palette.sel)); }

    // „ÉÑ„Éº„É´„Éê„Éº„ÅÆÊ§úÁ¥¢„Åã„ÇâËµ∑Âãï
    const gs = document.getElementById('global-search');
    gs?.addEventListener('focus', ()=> showPalette(gs.value||''));
    gs?.addEventListener('keydown', (e)=>{
      if (e.key.length === 1 || e.key === 'Enter'){ showPalette(gs.value||''); e.preventDefault(); }
    });
  }

  // Êó•Êú¨Ë™û„É©„Éô„É´„Å®„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆÈÅ©Áî®
  function localizeAndShortcuts(){
    try {
      document.title = 'ÁÆ°ÁêÜ„Ç≥„É≥„ÇΩ„Éº„É´';
      const vt = document.getElementById('view-title'); if (vt && /ÔøΩ|Ë™≠/.test(vt.textContent||'')) vt.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
      const map = { news: 'üì∞ „ÅäÁü•„Çâ„Åõ', activities: 'üß≠ Ê¥ªÂãï', settings: '‚öôÔ∏è Ë®≠ÂÆö', branding: 'üé® „Éñ„É©„É≥„Éá„Ç£„É≥„Ç∞' };
      document.querySelectorAll('.links [data-nav]').forEach(btn => { const k = btn.getAttribute('data-nav'); if (map[k]) btn.textContent = map[k]; });
      const brand = document.querySelector('.app-nav .brand h1'); if (brand) brand.textContent = 'ÁÆ°ÁêÜ„É°„Éã„É•„Éº';
      const menuBtn = document.getElementById('menu-toggle'); if (menuBtn) { menuBtn.textContent = '‚ò∞'; menuBtn.setAttribute('aria-label','„É°„Éã„É•„Éº„ÇíÈñã„Åè'); }
      const gs = document.getElementById('global-search'); if (gs) { gs.placeholder = 'Ê§úÁ¥¢ÔºàCtrl/Cmd + KÔºâ'; gs.setAttribute('aria-label','„Ç∞„É≠„Éº„Éê„É´Ê§úÁ¥¢'); }
      const qn = document.getElementById('quick-new-news'); if (qn) { qn.textContent = 'Êñ∞Ë¶è„ÅäÁü•„Çâ„Åõ'; qn.title = '„ÅäÁü•„Çâ„Åõ„ÇíÊñ∞Ë¶è‰ΩúÊàê'; }
      const qa = document.getElementById('quick-new-activity'); if (qa) { qa.textContent = 'Êñ∞Ë¶èÊ¥ªÂãï'; qa.title = 'Ê¥ªÂãï„ÇíÊñ∞Ë¶è‰ΩúÊàê'; }
    } catch {}

    // ‰∏ªË¶Å„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener('keydown', (e) => {
      const mod = (e.ctrlKey || e.metaKey);
      // ÁîªÈù¢ÁßªÂãï: g + n/a/s/b
      if (!mod && e.key.toLowerCase() === 'g'){
        const handler = (ev)=>{
          const k = ev.key.toLowerCase();
          if (k === 'n') setActive('news');
          if (k === 'a') setActive('activities');
          if (k === 's') setActive('settings');
          if (k === 'b') setActive('branding');
          window.removeEventListener('keydown', handler, true);
        };
        window.addEventListener('keydown', handler, true);
        return;
      }
      // Êñ∞Ë¶è‰ΩúÊàê
      if (mod && e.shiftKey && e.key.toLowerCase() === 'n'){ e.preventDefault(); setActive('news_new'); }
      if (mod && e.shiftKey && e.key.toLowerCase() === 'a'){ e.preventDefault(); setActive('activity_new'); }
      // „É°„Éã„É•„ÉºÈñãÈñâ
      if (e.key === 'Escape'){ document.querySelector('.app-nav')?.classList.remove('open'); }
      if (mod && e.key.toLowerCase() === 'm'){ e.preventDefault(); document.querySelector('.app-nav')?.classList.toggle('open'); }
      // Alt + Êï∞Â≠ó„ÅßÂàáÊõø
      if (e.altKey && ['1','2','3','4'].includes(e.key)){
        e.preventDefault();
        const keys = ['news','activities','settings','branding'];
        setActive(keys[Number(e.key)-1] || 'news');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await ensureSession();
    initNav();
    initZoom();
    await initPalette();
    localizeAndShortcuts();
    const initial = new URLSearchParams(location.search).get('view') || localStorage.getItem('admin.active') || 'news';
    setActive(initial in routes ? initial : 'news');
  });
})();

