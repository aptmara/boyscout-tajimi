<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記事の編集</title>
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
    <div class="container">
        <h1 id="page-title">新規記事の作成</h1>
        <form id="edit-form">
            <input type="hidden" id="article-id" name="id">
            <div class="form-group">
                <label for="title">タイトル</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="content">内容</label>
                <textarea id="content" name="content" required></textarea>
            </div>
            <!-- 既存のタイトル/本文の下あたりに追加 -->
			<label class="block text-sm font-medium text-gray-700 mt-4">カテゴリ</label>
			<input id="news-category" type="text" class="mt-1 block w-full border rounded p-2" placeholder="例: お知らせ">

            <button type="submit">保存</button>
            <a href="dashboard.html"><button type="button">キャンセル</button></a>
        </form>
        <p id="error-message" class="error-message"></p>
    </div>

    <script>
        const form = document.getElementById('edit-form');
        const pageTitle = document.getElementById('page-title');
        const articleIdInput = document.getElementById('article-id');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const errorMessage = document.getElementById('error-message');
        const categoryInput = document.getElementById('news-category');

        // --- unit/tags controls (insert dynamically before submit button) ---
        const formEl = document.getElementById('edit-form');
        const unitLabel = document.createElement('label');
        unitLabel.className = 'block text-sm font-medium text-gray-700 mt-4';
        unitLabel.textContent = '隊別';
        const unitSelect = document.createElement('select');
        unitSelect.id = 'news-unit';
        unitSelect.className = 'mt-1 block w-full border rounded p-2';
        const unitOptEmpty = document.createElement('option');
        unitOptEmpty.value = '';
        unitOptEmpty.textContent = '（未指定）';
        unitSelect.appendChild(unitOptEmpty);

        const tagsLabel = document.createElement('label');
        tagsLabel.className = 'block text-sm font-medium text-gray-700 mt-4';
        tagsLabel.textContent = 'タグ';
        const tagsSelect = document.createElement('select');
        tagsSelect.id = 'news-tags';
        tagsSelect.className = 'mt-1 block w-full border rounded p-2';
        tagsSelect.multiple = true;
        tagsSelect.size = 5;

        const submitBtn = formEl.querySelector('button[type="submit"]') || formEl.lastElementChild;
        formEl.insertBefore(unitLabel, submitBtn);
        formEl.insertBefore(unitSelect, submitBtn);
        formEl.insertBefore(tagsLabel, submitBtn);
        formEl.insertBefore(tagsSelect, submitBtn);

        // helpers
        let settingsCache = null;
        function parseJsonSafe(str, fallback) { try { return JSON.parse(str); } catch { return fallback; } }
        function normalizeSlug(s) { return String(s||'').trim().toLowerCase(); }
        function fillUnitAndTags({ currentUnit = '', currentTags = [] } = {}){
            const units = parseJsonSafe(settingsCache?.units_json || '[]', []);
            const tags  = parseJsonSafe(settingsCache?.news_tags_json || '[]', []);
            // unit
            unitSelect.innerHTML = '';
            const empty = document.createElement('option'); empty.value=''; empty.textContent='（未指定）'; unitSelect.appendChild(empty);
            for (const u of units) {
                const opt = document.createElement('option');
                opt.value = u.slug; opt.textContent = u.label;
                if (normalizeSlug(currentUnit) === normalizeSlug(u.slug)) opt.selected = true;
                unitSelect.appendChild(opt);
            }
            // tags
            tagsSelect.innerHTML = '';
            const cur = new Set(Array.isArray(currentTags)?currentTags.map(normalizeSlug):[]);
            for (const t of tags) {
                const opt = document.createElement('option');
                opt.value = t.slug; opt.textContent = t.label;
                if (cur.has(normalizeSlug(t.slug))) opt.selected = true;
                tagsSelect.appendChild(opt);
            }
        }

        let isEditMode = false;

        document.addEventListener('DOMContentLoaded', async () => {
            // ログイン状態の確認
            try {
                const sessionRes = await fetch('/api/session');
                const sessionData = await sessionRes.json();
                if (!sessionData.loggedIn) {
                    window.location.href = '/admin/login.html';
                    return;
                }
            } catch (error) {
                console.error('Session check failed:', error);
                window.location.href = '/admin/login.html';
                return;
            }

            // 編集モードかどうかの判定
            // Load settings for units/tags
            try {
                const res = await fetch('/api/settings/all');
                if (res.ok) {
                    const rows = await res.json();
                    settingsCache = rows.reduce((acc, r) => { acc[r.key] = r.value; return acc; }, {});
                } else { settingsCache = {}; }
            } catch { settingsCache = {}; }
            // Render empty first
            fillUnitAndTags();

            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');

            if (articleId) {
                isEditMode = true;
                articleIdInput.value = articleId;
                pageTitle.textContent = '記事の編集';

                // 既存の記事データを取得してフォームに設定
                try {
                    const response = await fetch(`/api/news/${articleId}`);
                    if (response.ok) {
                        const article = await response.json();
                        titleInput.value = article.title;
                        contentInput.value = article.content;
                        categoryInput.value = article.category || '';
                        fillUnitAndTags({ currentUnit: article.unit, currentTags: Array.isArray(article.tags)?article.tags:[] });
                    } else {
                        errorMessage.textContent = '記事の読み込みに失敗しました。';
                    }
                } catch (error) {
                    errorMessage.textContent = 'エラーが発生しました。';
                }
            }
        });

		form.addEventListener('submit', async (event) => {
		    event.preventDefault();
		    errorMessage.textContent = '';

		    const unitVal = document.getElementById('news-unit')?.value || null;
		    const tagsVal = Array.from(document.getElementById('news-tags')?.options || []).filter(o=>o.selected).map(o=>o.value);
		    const articleData = {
		        title: titleInput.value.trim(),
		        content: contentInput.value.trim(),
		        category: categoryInput.value.trim() || '未分類'
		    };

		    const url = isEditMode ? `/api/news/${articleIdInput.value}` : '/api/news';
		    const method = isEditMode ? 'PUT' : 'POST';

		    try {
		        const response = await fetch(url, {
		            method: method,
		            headers: { 'Content-Type': 'application/json' },
		            body: JSON.stringify(Object.assign({}, articleData, { unit: unitVal, tags: tagsVal }))
		        });

		        if (response.ok) {
		            window.location.href = 'dashboard.html';
		        } else {
		            const data = await response.json();
		            errorMessage.textContent = data.error || '保存に失敗しました。';
		        }
		    } catch (error) {
		        errorMessage.textContent = 'エラーが発生しました。';
		    }
		});

    </script>
</body>
</html>
