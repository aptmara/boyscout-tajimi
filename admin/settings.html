<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サイト設定 - 管理</title>
  <link rel="stylesheet" href="admin-styles.css">
  <script src="admin-ui.js"></script>
</head>
<body>
  <div class="header">
    <h1>サイト設定</h1>
    <div>
      <a href="dashboard.html"><button>ダッシュボードへ戻る</button></a>
      <button id="logout-button">ログアウト</button>
    </div>
  </div>

  <div class="container">
    <form id="settings-form">
      <style>
        .tabs { display:flex; gap:8px; border-bottom:1px solid var(--admin-border); margin-bottom:14px; flex-wrap:wrap; }
        .tab-btn { background:#fff; border:1px solid var(--admin-border); border-bottom:none; padding:8px 12px; border-top-left-radius:8px; border-top-right-radius:8px; cursor:pointer; color:var(--admin-text); }
        .tab-btn.active { background: var(--admin-primary-50, #eef7f1); color: var(--admin-primary-700, #0b6b3a); border-color: var(--admin-primary-200, #bfe3cc); font-weight:600; }
        .tab-panel { display:none; background:#fff; border:1px solid var(--admin-border); border-radius:0 8px 8px 8px; padding:16px; box-shadow: var(--admin-shadow); }
        .tab-panel.active { display:block; }
        .panel-columns { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 860px) { .panel-columns { grid-template-columns: 1fr; } }
        .toolbar { display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 10px; }
        .toolbar .btn { background:#fff; color: var(--admin-text); border:1px solid var(--admin-border); padding:8px 12px; border-radius:8px; cursor:pointer; }
        .form-group.invalid input { border-color: var(--admin-danger); }
        .hint { color: var(--admin-text-muted); font-size: 12px; margin-top: 4px; }
        .img-preview { border:1px dashed var(--admin-border); padding:8px; border-radius:8px; background:#fafafa; margin-top:6px; display:none; }
        .img-preview img { max-width:100%; height:auto; display:block; }
        /* --- New side layout --- */
        .settings-layout { display:grid; grid-template-columns: 1fr 260px; gap: 16px; align-items:start; }
        .content-pane { background:#fff; border:1px solid var(--admin-border); border-radius:8px; padding:16px; box-shadow: var(--admin-shadow); min-height: 480px; }
        .side-menu { position:sticky; top:12px; align-self:start; background:#fff; border:1px solid var(--admin-border); border-radius:8px; padding:8px; box-shadow: var(--admin-shadow); }
        .side-menu h3 { margin:8px 8px 6px; font-size:14px; color: var(--admin-text-muted); }
        .menu-list { display:flex; flex-direction:column; gap:4px; }
        .menu-btn { width:100%; text-align:left; padding:10px 12px; border:none; background:#fff; border-radius:6px; cursor:pointer; color:var(--admin-text); }
        .menu-btn.active { background: var(--admin-primary-50, #eef7f1); color: var(--admin-primary-800, #0b6b3a); font-weight:600; }
        .panel-columns { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 980px) {
          .settings-layout { grid-template-columns: 1fr; }
          /* モバイルではサイドメニューをドロワー化 */
          .side-menu { position: fixed; right: 0; top: 0; bottom: 0; width: min(86vw, 320px); transform: translateX(100%); transition: transform .25s ease; z-index: 60; }
          .side-menu.open { transform: translateX(0); }
        }
        .side-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,.35); display: none; z-index: 59; }
        .side-backdrop.open { display: block; }
        /* Hide legacy tabs */
        .tabs, .tab-panel { display:none !important; }
      </style>

      <!-- New 2-pane layout: left content, right menu -->
      <div class="settings-layout">
        <div class="content-pane">
          <div class="toolbar" style="display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn" id="btn-save-draft">下書き保存</button>
              <button type="button" class="btn" id="btn-restore-draft">下書きを復元</button>
              <button type="button" class="btn" id="btn-discard-draft">下書きを破棄</button>
              <button type="button" class="btn" id="btn-import-task">task.txt から取り込み</button>
            </div>
            <div class="toolbar-actions" style="display:flex; gap:8px; align-items:center;">
              <button type="button" class="btn btn-ghost" id="menu-toggle" aria-label="メニューを開く">メニュー</button>
              <button type="button" class="btn btn-secondary" id="btn-save-top">保存</button>
              <a href="dashboard.html"><button type="button" class="btn btn-ghost" id="btn-cancel-top">キャンセル</button></a>
              <button type="button" class="btn btn-ghost" id="btn-help" title="ヘルプ" aria-label="ヘルプ">?</button>
            </div>
          </div>
          <div id="content-area"></div>
        </div>
        <aside class="side-menu" aria-label="設定カテゴリ">
          <h3>大枠の設定</h3>
          <div style="padding:6px 8px 8px;">
            <input id="menu-search" type="search" placeholder="カテゴリを検索..." aria-label="カテゴリ検索" style="width:100%;padding:8px 10px;border:1px solid var(--admin-border);border-radius:8px;">
          </div>
          <div class="menu-list" id="menu-list"></div>
        </aside>
        <div class="side-backdrop" id="side-backdrop" aria-hidden="true"></div>
      </div>

      <nav class="tabs" id="settings-tabs">
        <button type="button" class="tab-btn" data-tab="contact">基本情報</button>
        <button type="button" class="tab-btn" data-tab="privacy">プライバシー</button>
        <button type="button" class="tab-btn" data-tab="leader_names">リーダー名</button>
        <button type="button" class="tab-btn" data-tab="branding">ブランディング</button>
        <button type="button" class="tab-btn" data-tab="leader_profile">リーダー写真/メッセージ</button>
        <button type="button" class="tab-btn" data-tab="gallery">ギャラリー</button>
        <button type="button" class="tab-btn" data-tab="top_images">トップ画像</button>
        <button type="button" class="tab-btn" data-tab="activity">�K�ɗ���</button>
      </nav>

      <div class="toolbar">
        <button type="button" class="btn" id="btn-save-draft">下書きを保存</button>
        <button type="button" class="btn" id="btn-restore-draft">下書きを復元</button>
        <button type="button" class="btn" id="btn-discard-draft">下書きを破棄</button>
        <button type="button" class="btn" id="btn-import-task">task.txt取り込み</button>
      </div>

      <div id="tab-contact" class="tab-panel"><div class="panel-columns" data-fields="contact"></div></div>
      <div id="tab-privacy" class="tab-panel"><div class="panel-columns" data-fields="privacy"></div></div>
      <div id="tab-leader_names" class="tab-panel"><div class="panel-columns" data-fields="leader_names"></div></div>
      <div id="tab-branding" class="tab-panel"><div class="panel-columns" data-fields="branding"></div></div>
      <div id="tab-leader_profile" class="tab-panel"><div class="panel-columns" data-fields="leader_profile"></div></div>
      <div id="tab-gallery" class="tab-panel"><div class="panel-columns" data-fields="gallery"></div></div>
      <div id="tab-top_images" class="tab-panel"><div class="panel-columns" data-fields="top_images"></div></div>
      <div id="tab-activity" class="tab-panel">
        <div class="toolbar" style="margin-top:0; display:flex; gap:8px; align-items:center;">
          <input type="search" id="activity-search" placeholder="活動を検索..." aria-label="活動 検索" style="flex:1;min-width:220px">
          <select id="activity-unit-filter" aria-label="隊フィルター">
            <option value="">すべての隊</option>
          </select>
          <a href="activity-edit.html"><button type="button" class="btn btn-secondary">新規作成</button></a>
        </div>
        <ul id="activity-list" class="news-list"></ul>
        <p id="activity-error" class="error-message"></p>
      </div>
      <h2>連絡先・共通情報</h2>
      <div class="form-group">
        <label for="contact_address">住所</label>
        <input type="text" id="contact_address" name="contact_address" placeholder="〒XXX-XXXX 岐阜県多治見市XX町X-X-X">
      </div>
      <div class="form-group">
        <label for="contact_phone">電話番号（代表）</label>
        <input type="text" id="contact_phone" name="contact_phone" placeholder="0572-XX-XXXX">
      </div>
      <div class="form-group">
        <label for="contact_secondary_phone">電話番号（サブ）</label>
        <input type="text" id="contact_secondary_phone" name="contact_secondary_phone" placeholder="0572-00-0000 など">
      </div>
      <div class="form-group">
        <label for="contact_email">メールアドレス</label>
        <input type="email" id="contact_email" name="contact_email" placeholder="info@bs-tajimi1.example.jp">
      </div>
      <div class="form-group">
        <label for="contact_person_name">お問い合わせ担当者名</label>
        <input type="text" id="contact_person_name" name="contact_person_name" placeholder="担当者名">
      </div>

      <h2>プライバシーポリシー表示項目</h2>
      <div class="form-group">
        <label for="privacy_contact_person">窓口担当（氏名・役職）</label>
        <input type="text" id="privacy_contact_person" name="privacy_contact_person" placeholder="例）団委員長 ○○ ○○">
      </div>
      <div class="form-group">
        <label for="privacy_contact_phone">窓口電話番号</label>
        <input type="text" id="privacy_contact_phone" name="privacy_contact_phone" placeholder="電話番号を記載">
      </div>
      <div class="form-group">
        <label for="privacy_contact_email">窓口メールアドレス</label>
        <input type="email" id="privacy_contact_email" name="privacy_contact_email" placeholder="メールアドレスを記載">
      </div>
      <div class="form-group">
        <label for="privacy_effective_date">制定日</label>
        <input type="text" id="privacy_effective_date" name="privacy_effective_date" placeholder="例）2025年5月12日">
      </div>
      <div class="form-group">
        <label for="privacy_last_updated_date">最終更新日</label>
        <input type="text" id="privacy_last_updated_date" name="privacy_last_updated_date" placeholder="例）2025年5月12日">
      </div>

      <h2>各隊リーダー名</h2>
      <div class="form-group"><label for="leader_beaver">ビーバー隊リーダー</label><input type="text" id="leader_beaver" name="leader_beaver" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_cub">カブ隊リーダー</label><input type="text" id="leader_cub" name="leader_cub" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_boy">ボーイ隊隊長</label><input type="text" id="leader_boy" name="leader_boy" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_venture">ベンチャー隊隊長</label><input type="text" id="leader_venture" name="leader_venture" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_rover">ローバー隊アドバイザー</label><input type="text" id="leader_rover" name="leader_rover" placeholder="氏名"></div>

      <h2>トップページ画像URL</h2>
      <div class="form-group"><label for="index_hero_image_url">ヒーロー画像URL</label><input type="text" id="index_hero_image_url" name="index_hero_image_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_highlight_img_1_url">活動ハイライト1</label><input type="text" id="index_highlight_img_1_url" name="index_highlight_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_highlight_img_2_url">活動ハイライト2</label><input type="text" id="index_highlight_img_2_url" name="index_highlight_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_highlight_img_3_url">活動ハイライト3</label><input type="text" id="index_highlight_img_3_url" name="index_highlight_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_testimonial_img_1_url">プロフィール画像1</label><input type="text" id="index_testimonial_img_1_url" name="index_testimonial_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_testimonial_img_2_url">プロフィール画像2</label><input type="text" id="index_testimonial_img_2_url" name="index_testimonial_img_2_url" placeholder="https://..."></div>

      <h2>お問い合わせページ</h2>
      <div class="form-group">
        <label for="contact_map_embed_html">Googleマップ埋め込みHTML</label>
        <textarea id="contact_map_embed_html" name="contact_map_embed_html" rows="5" placeholder="&lt;iframe ...&gt;&lt;/iframe&gt;"></textarea>
      </div>

      <h2>団章・各隊ロゴ URL</h2>
      <div class="form-group"><label for="group_crest_url">団章（ヘッダー/フッター）</label><input type="text" id="group_crest_url" name="group_crest_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_logo_url">ビーバー隊章（ロゴ）</label><input type="text" id="unit_beaver_logo_url" name="unit_beaver_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_logo_url">カブ隊章（ロゴ）</label><input type="text" id="unit_cub_logo_url" name="unit_cub_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_logo_url">ボーイ隊章（ロゴ）</label><input type="text" id="unit_boy_logo_url" name="unit_boy_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_logo_url">ベンチャー隊章（ロゴ）</label><input type="text" id="unit_venture_logo_url" name="unit_venture_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_logo_url">ローバー隊章（ロゴ）</label><input type="text" id="unit_rover_logo_url" name="unit_rover_logo_url" placeholder="https://..."></div>

      <h2>各隊 リーダー写真・メッセージ</h2>
      <div class="form-group"><label for="unit_beaver_leader_photo_url">ビーバー リーダー写真URL</label><input type="text" id="unit_beaver_leader_photo_url" name="unit_beaver_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_leader_message">ビーバー メッセージ</label><textarea id="unit_beaver_leader_message" name="unit_beaver_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_cub_leader_photo_url">カブ リーダー写真URL</label><input type="text" id="unit_cub_leader_photo_url" name="unit_cub_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_leader_message">カブ メッセージ</label><textarea id="unit_cub_leader_message" name="unit_cub_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_boy_leader_photo_url">ボーイ リーダー写真URL</label><input type="text" id="unit_boy_leader_photo_url" name="unit_boy_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_leader_message">ボーイ メッセージ</label><textarea id="unit_boy_leader_message" name="unit_boy_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_venture_leader_photo_url">ベンチャー リーダー写真URL</label><input type="text" id="unit_venture_leader_photo_url" name="unit_venture_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_leader_message">ベンチャー メッセージ</label><textarea id="unit_venture_leader_message" name="unit_venture_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_rover_leader_photo_url">ローバー リーダー写真URL</label><input type="text" id="unit_rover_leader_photo_url" name="unit_rover_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_leader_message">ローバー メッセージ</label><textarea id="unit_rover_leader_message" name="unit_rover_leader_message" rows="3" placeholder="メッセージ"></textarea></div>

      <h2>各隊 ギャラリー画像URL（最大4枚）</h2>
      <h3>ビーバー</h3>
      <div class="form-group"><label for="unit_beaver_gallery_img_1_url">画像1</label><input type="text" id="unit_beaver_gallery_img_1_url" name="unit_beaver_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_gallery_img_2_url">画像2</label><input type="text" id="unit_beaver_gallery_img_2_url" name="unit_beaver_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_gallery_img_3_url">画像3</label><input type="text" id="unit_beaver_gallery_img_3_url" name="unit_beaver_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_gallery_img_4_url">画像4</label><input type="text" id="unit_beaver_gallery_img_4_url" name="unit_beaver_gallery_img_4_url" placeholder="https://..."></div>
      <h3>カブ</h3>
      <div class="form-group"><label for="unit_cub_gallery_img_1_url">画像1</label><input type="text" id="unit_cub_gallery_img_1_url" name="unit_cub_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_gallery_img_2_url">画像2</label><input type="text" id="unit_cub_gallery_img_2_url" name="unit_cub_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_gallery_img_3_url">画像3</label><input type="text" id="unit_cub_gallery_img_3_url" name="unit_cub_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_gallery_img_4_url">画像4</label><input type="text" id="unit_cub_gallery_img_4_url" name="unit_cub_gallery_img_4_url" placeholder="https://..."></div>
      <h3>ボーイ</h3>
      <div class="form-group"><label for="unit_boy_gallery_img_1_url">画像1</label><input type="text" id="unit_boy_gallery_img_1_url" name="unit_boy_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_gallery_img_2_url">画像2</label><input type="text" id="unit_boy_gallery_img_2_url" name="unit_boy_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_gallery_img_3_url">画像3</label><input type="text" id="unit_boy_gallery_img_3_url" name="unit_boy_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_gallery_img_4_url">画像4</label><input type="text" id="unit_boy_gallery_img_4_url" name="unit_boy_gallery_img_4_url" placeholder="https://..."></div>
      <h3>ベンチャー</h3>
      <div class="form-group"><label for="unit_venture_gallery_img_1_url">画像1</label><input type="text" id="unit_venture_gallery_img_1_url" name="unit_venture_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_gallery_img_2_url">画像2</label><input type="text" id="unit_venture_gallery_img_2_url" name="unit_venture_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_gallery_img_3_url">画像3</label><input type="text" id="unit_venture_gallery_img_3_url" name="unit_venture_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_gallery_img_4_url">画像4</label><input type="text" id="unit_venture_gallery_img_4_url" name="unit_venture_gallery_img_4_url" placeholder="https://..."></div>
      <h3>ローバー</h3>
      <div class="form-group"><label for="unit_rover_gallery_img_1_url">画像1</label><input type="text" id="unit_rover_gallery_img_1_url" name="unit_rover_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_gallery_img_2_url">画像2</label><input type="text" id="unit_rover_gallery_img_2_url" name="unit_rover_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_gallery_img_3_url">画像3</label><input type="text" id="unit_rover_gallery_img_3_url" name="unit_rover_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_gallery_img_4_url">画像4</label><input type="text" id="unit_rover_gallery_img_4_url" name="unit_rover_gallery_img_4_url" placeholder="https://..."></div>

      <div class="form-actions">
        <button type="submit" id="btn-save-bottom">保存</button>
        <a href="dashboard.html"><button type="button" id="btn-cancel-bottom">キャンセル</button></a>
      </div>
      <p id="save-message" class="success-message" style="display:none;">保存しました。</p>
      <p id="error-message" class="error-message"></p>
    </form>
  </div>

  <script>
    async function ensureLoggedIn() {
      try {
        const r = await fetch('/api/session', { credentials: 'same-origin' });
        const d = await r.json();
        if (!d.loggedIn) { window.location.href = '/admin/login.html'; }
      } catch { window.location.href = '/admin/login.html'; }
    }

    function fillForm(settings) {
      const fields = [
        'contact_address','contact_phone','contact_secondary_phone','contact_email','contact_person_name',
        'privacy_contact_person','privacy_contact_phone','privacy_contact_email','privacy_effective_date','privacy_last_updated_date',
        'leader_beaver','leader_cub','leader_boy','leader_venture','leader_rover',
        'index_hero_image_url','index_highlight_img_1_url','index_highlight_img_2_url','index_highlight_img_3_url',
        'index_testimonial_img_1_url','index_testimonial_img_2_url','contact_map_embed_html'
      ];
      fields.forEach(k => {
        const el = document.getElementById(k);
        if (!el) return;
        el.value = settings[k] || '';
      });

      // 追加フィールドも一括反映（name/id が設定キーと同じもの）
      document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(el => {
        const key = el.name || el.id;
        if (!key) return;
        if (typeof settings[key] !== 'undefined') {
          el.value = settings[key];
        }
      });
    }

    /* legacy tabs removed */

    // --- Side menu rendering for clarity-first UI ---
    function initSideMenu() {
      const content = document.getElementById('content-area');
      const menu = document.getElementById('menu-list');

      const CATEGORY_LABELS = {
        contact: '連絡先',
        privacy: 'プライバシー',
        leader_names: 'リーダー名',
        branding: 'ブランディング',
        leader_profile: 'リーダープロフィール',
        gallery: 'ギャラリー',
        top_images: 'トップ画像',
        activity: '活動管理'
      };

      const GROUPS = new Map([
        ['contact', ['contact_address','contact_phone','contact_secondary_phone','contact_email','contact_person_name','contact_map_embed_html']],
        ['privacy', ['privacy_contact_person','privacy_contact_phone','privacy_contact_email','privacy_effective_date','privacy_last_updated_date']],
        ['leader_names', ['leader_beaver','leader_cub','leader_boy','leader_venture','leader_rover']],
        ['branding', ['group_crest_url','unit_beaver_logo_url','unit_cub_logo_url','unit_boy_logo_url','unit_venture_logo_url','unit_rover_logo_url']],
        ['leader_profile', [
          'unit_beaver_leader_photo_url','unit_beaver_leader_message',
          'unit_cub_leader_photo_url','unit_cub_leader_message',
          'unit_boy_leader_photo_url','unit_boy_leader_message',
          'unit_venture_leader_photo_url','unit_venture_leader_message',
          'unit_rover_leader_photo_url','unit_rover_leader_message'
        ]],
        ['gallery', [
          'unit_beaver_gallery_img_1_url','unit_beaver_gallery_img_2_url','unit_beaver_gallery_img_3_url','unit_beaver_gallery_img_4_url',
          'unit_cub_gallery_img_1_url','unit_cub_gallery_img_2_url','unit_cub_gallery_img_3_url','unit_cub_gallery_img_4_url',
          'unit_boy_gallery_img_1_url','unit_boy_gallery_img_2_url','unit_boy_gallery_img_3_url','unit_boy_gallery_img_4_url',
          'unit_venture_gallery_img_1_url','unit_venture_gallery_img_2_url','unit_venture_gallery_img_3_url','unit_venture_gallery_img_4_url',
          'unit_rover_gallery_img_1_url','unit_rover_gallery_img_2_url','unit_rover_gallery_img_3_url','unit_rover_gallery_img_4_url'
        ]],
        ['top_images', ['index_hero_image_url','index_highlight_img_1_url','index_highlight_img_2_url','index_highlight_img_3_url','index_testimonial_img_1_url','index_testimonial_img_2_url']],
      ]);

      const FIELD_META = {
        contact_address: { label: '住所', placeholder: '〒XXX-XXXX 多治見市XX町X-X-X' },
        contact_phone: { label: '電話番号（代表）', placeholder: '0572-XX-XXXX' },
        contact_secondary_phone: { label: '電話番号（サブ）', placeholder: '0572-00-0000 など' },
        contact_email: { label: 'メールアドレス', placeholder: 'info@example.jp' },
        contact_person_name: { label: '担当者名', placeholder: '例）山田 太郎' },
        contact_map_embed_html: { label: '地図埋め込みHTML', textarea: true, placeholder: '<iframe ...></iframe>' },
        privacy_contact_person: { label: '問い合わせ窓口（氏名）' },
        privacy_contact_phone: { label: '問い合わせ窓口（電話）' },
        privacy_contact_email: { label: '問い合わせ窓口（メール）' },
        privacy_effective_date: { label: '施行日', placeholder: 'YYYY-MM-DD' },
        privacy_last_updated_date: { label: '最終更新日', placeholder: 'YYYY-MM-DD' },
        leader_beaver: { label: 'ビーバー隊長名' },
        leader_cub: { label: 'カブ隊長名' },
        leader_boy: { label: 'ボーイ隊長名' },
        leader_venture: { label: 'ベンチャー隊長名' },
        leader_rover: { label: 'ローバー隊長名' },
        group_crest_url: { label: '団章画像URL', placeholder: 'https://...' },
        unit_beaver_logo_url: { label: 'ビーバー隊ロゴURL', placeholder: 'https://...' },
        unit_cub_logo_url: { label: 'カブ隊ロゴURL', placeholder: 'https://...' },
        unit_boy_logo_url: { label: 'ボーイ隊ロゴURL', placeholder: 'https://...' },
        unit_venture_logo_url: { label: 'ベンチャー隊ロゴURL', placeholder: 'https://...' },
        unit_rover_logo_url: { label: 'ローバー隊ロゴURL', placeholder: 'https://...' },
        unit_beaver_leader_photo_url: { label: 'ビーバー リーダー写真URL', placeholder: 'https://...' },
        unit_beaver_leader_message: { label: 'ビーバー リーダーメッセージ', textarea: true },
        unit_cub_leader_photo_url: { label: 'カブ リーダー写真URL', placeholder: 'https://...' },
        unit_cub_leader_message: { label: 'カブ リーダーメッセージ', textarea: true },
        unit_boy_leader_photo_url: { label: 'ボーイ リーダー写真URL', placeholder: 'https://...' },
        unit_boy_leader_message: { label: 'ボーイ リーダーメッセージ', textarea: true },
        unit_venture_leader_photo_url: { label: 'ベンチャー リーダー写真URL', placeholder: 'https://...' },
        unit_venture_leader_message: { label: 'ベンチャー リーダーメッセージ', textarea: true },
        unit_rover_leader_photo_url: { label: 'ローバー リーダー写真URL', placeholder: 'https://...' },
        unit_rover_leader_message: { label: 'ローバー リーダーメッセージ', textarea: true },
        unit_beaver_gallery_img_1_url: { label: 'ビーバー 画像1', placeholder: 'https://...' },
        unit_beaver_gallery_img_2_url: { label: 'ビーバー 画像2', placeholder: 'https://...' },
        unit_beaver_gallery_img_3_url: { label: 'ビーバー 画像3', placeholder: 'https://...' },
        unit_beaver_gallery_img_4_url: { label: 'ビーバー 画像4', placeholder: 'https://...' },
        unit_cub_gallery_img_1_url: { label: 'カブ 画像1', placeholder: 'https://...' },
        unit_cub_gallery_img_2_url: { label: 'カブ 画像2', placeholder: 'https://...' },
        unit_cub_gallery_img_3_url: { label: 'カブ 画像3', placeholder: 'https://...' },
        unit_cub_gallery_img_4_url: { label: 'カブ 画像4', placeholder: 'https://...' },
        unit_boy_gallery_img_1_url: { label: 'ボーイ 画像1', placeholder: 'https://...' },
        unit_boy_gallery_img_2_url: { label: 'ボーイ 画像2', placeholder: 'https://...' },
        unit_boy_gallery_img_3_url: { label: 'ボーイ 画像3', placeholder: 'https://...' },
        unit_boy_gallery_img_4_url: { label: 'ボーイ 画像4', placeholder: 'https://...' },
        unit_venture_gallery_img_1_url: { label: 'ベンチャー 画像1', placeholder: 'https://...' },
        unit_venture_gallery_img_2_url: { label: 'ベンチャー 画像2', placeholder: 'https://...' },
        unit_venture_gallery_img_3_url: { label: 'ベンチャー 画像3', placeholder: 'https://...' },
        unit_venture_gallery_img_4_url: { label: 'ベンチャー 画像4', placeholder: 'https://...' },
        unit_rover_gallery_img_1_url: { label: 'ローバー 画像1', placeholder: 'https://...' },
        unit_rover_gallery_img_2_url: { label: 'ローバー 画像2', placeholder: 'https://...' },
        unit_rover_gallery_img_3_url: { label: 'ローバー 画像3', placeholder: 'https://...' },
        unit_rover_gallery_img_4_url: { label: 'ローバー 画像4', placeholder: 'https://...' },
        index_hero_image_url: { label: 'ヒーロー画像URL', placeholder: 'https://...' },
        index_highlight_img_1_url: { label: 'ハイライト画像1 URL', placeholder: 'https://...' },
        index_highlight_img_2_url: { label: 'ハイライト画像2 URL', placeholder: 'https://...' },
        index_highlight_img_3_url: { label: 'ハイライト画像3 URL', placeholder: 'https://...' },
        index_testimonial_img_1_url: { label: '体験談画像1 URL', placeholder: 'https://...' },
        index_testimonial_img_2_url: { label: '体験談画像2 URL', placeholder: 'https://...' }
      };

      const UNIT_TITLES = { beaver: 'ビーバー', cub: 'カブ', boy: 'ボーイ', venture: 'ベンチャー', rover: 'ローバー' };

      function createField(id){
        const meta = FIELD_META[id] || { label: id };
        const wrap = document.createElement('div');
        wrap.className = 'form-group';
        const label = document.createElement('label');
        label.setAttribute('for', id);
        label.textContent = meta.label || id;
        wrap.appendChild(label);
        let input;
        if (meta.textarea) { input = document.createElement('textarea'); input.rows = 4; }
        else { input = document.createElement('input'); input.type = 'text'; }
        input.id = id; input.name = id; if (meta.placeholder) input.placeholder = meta.placeholder;
        wrap.appendChild(input);
        return wrap;
      }

      function renderFields(category){
        content.innerHTML = '';
        const title = document.createElement('h2'); title.className = 'section-title'; title.textContent = CATEGORY_LABELS[category] || category; content.appendChild(title);
        const ids = GROUPS.get(category) || [];
        if (category === 'leader_profile'){
          ['beaver','cub','boy','venture','rover'].forEach(unit => {
            const h = document.createElement('div'); h.className='subsection-title'; h.textContent = UNIT_TITLES[unit]; content.appendChild(h);
            const grid = document.createElement('div'); grid.className='panel-columns'; content.appendChild(grid);
            [ `unit_${unit}_leader_photo_url`, `unit_${unit}_leader_message` ].forEach(fid => { grid.appendChild(createField(fid)); });
          });
          return;
        }
        if (category === 'gallery'){
          ['beaver','cub','boy','venture','rover'].forEach(unit => {
            const h = document.createElement('div'); h.className='subsection-title'; h.textContent = UNIT_TITLES[unit]; content.appendChild(h);
            const grid = document.createElement('div'); grid.className='panel-columns'; content.appendChild(grid);
            [1,2,3,4].forEach(n => { grid.appendChild(createField(`unit_${unit}_gallery_img_${n}_url`)); });
          });
          return;
        }
        const grid = document.createElement('div'); grid.className = 'panel-columns'; content.appendChild(grid);
        ids.forEach(id => grid.appendChild(createField(id)));
      }

      function renderActivity(){
        content.innerHTML = '';
        const title = document.createElement('h2'); title.className='section-title'; title.textContent = '活動管理'; content.appendChild(title);
        const bar = document.createElement('div'); bar.className='toolbar'; bar.style.marginTop = '0'; bar.style.alignItems='center';
        bar.innerHTML = '<input type="search" id="activity-search" placeholder="キーワードで検索..." aria-label="活動 検索" style="flex:1;min-width:220px">\
          <select id="activity-unit-filter" aria-label="隊フィルター"><option value="">すべての隊</option></select>\
          <a href="activity-edit.html"><button type="button" class="btn btn-secondary">新規作成</button></a>';
        content.appendChild(bar);
        const ul = document.createElement('ul'); ul.id='activity-list'; ul.className='news-list'; content.appendChild(ul);
        const p = document.createElement('p'); p.id='activity-error'; p.className='error-message'; content.appendChild(p);
        ensureActivitiesLoaded();
      }

      function activate(category){
        Array.from(menu.querySelectorAll('.menu-btn')).forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
        localStorage.setItem('admin_settings_active_tab', category);
        if (category === 'activity') renderActivity(); else renderFields(category);
      }

      // メニュー描画
      Object.keys(CATEGORY_LABELS).forEach(key => {
        const btn = document.createElement('button');
        btn.type = 'button'; btn.className = 'menu-btn'; btn.dataset.category = key; btn.textContent = CATEGORY_LABELS[key];
        btn.addEventListener('click', () => activate(key));
        menu.appendChild(btn);
      });

      const params = new URLSearchParams(location.search);
      const initial = params.get('tab') || localStorage.getItem('admin_settings_active_tab') || 'contact';
      activate(initial);

      // 旧コンテンツ（静的フィールド群やタブ）は非表示にする
      document.querySelectorAll('#settings-form > .form-group, #settings-form > h2, #settings-form > h3, .tab-panel, .tabs').forEach(el => { el.style.display = 'none'; });
    }

    function isUrl(str){ try { const u = new URL(str); return u.protocol === 'http:' || u.protocol === 'https:'; } catch { return false; } }
    function setupUrlPreviews(){
      const inputs = Array.from(document.querySelectorAll('#settings-form input[type="text"], #settings-form input[type="url"]'));
      inputs.forEach(input => {
        const key = input.name || input.id || '';
        if (!key.endsWith('_url') && key !== 'group_crest_url') return;
        let preview = input.parentElement.querySelector('.img-preview');
        if (!preview){ preview = document.createElement('div'); preview.className='img-preview'; preview.innerHTML='<img alt="preview"><div class="hint"><a class="open-link" target="_blank" rel="noopener">新しいタブで開く</a></div>'; input.parentElement.appendChild(preview); }
        const img = preview.querySelector('img');
        const link = preview.querySelector('.open-link');
        const update = () => {
          const v = (input.value || '').trim();
          if (v && isUrl(v)) { img.src = v; link.href = v; preview.style.display='block'; input.parentElement.classList.remove('invalid'); }
          else { preview.style.display='none'; if (v) input.parentElement.classList.add('invalid'); else input.parentElement.classList.remove('invalid'); }
        };
        input.addEventListener('input', update);
        update();
      });
    }

    function applyPayloadToForm(payload){
      Object.entries(payload || {}).forEach(([k,v]) => {
        const el = document.querySelector(`#settings-form [name="${k}"]`) || document.getElementById(k);
        if (el) el.value = v;
      });
    }

    // ---- Activity viewer (read-only) ----
    let activitiesLoaded = false;
    let activitiesData = [];
    function escapeHTML(str){
      return String(str||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
    function formatDate(iso){ try { const d = new Date(iso); if (isNaN(d)) return ''; return d.toLocaleDateString('ja-JP'); } catch { return ''; } }
    async function loadActivities(){
      try {
        const res = await fetch('/api/activities?limit=200', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('failed');
        activitiesData = await res.json();
      } catch (e) {
        const err = document.getElementById('activity-error');
        if (err) err.textContent = '�K�ɗ���̓ǂݍ��݂Ɏ��s���܂����B';
        activitiesData = [];
      }
    }
    async function loadUnitsToFilter(){
      try {
        const r = await fetch('/api/settings/all', { credentials: 'same-origin' });
        if (!r.ok) return;
        const rows = await r.json();
        const map = rows.reduce((acc, it) => (acc[it.key] = it.value, acc), {});
        const units = JSON.parse(map.units_json || '[]');
        const sel = document.getElementById('activity-unit-filter');
        if (sel) {
          sel.innerHTML = '<option value="">すべての隊</option>' + (Array.isArray(units)?units.map(u=>`<option value="${(u.slug||'').toString()}">${(u.label||u.slug||'').toString()}</option>`).join(''): '');
        }
      } catch {}
    }
    function renderActivities(){
      const list = document.getElementById('activity-list'); if (!list) return;
      const q = String(document.getElementById('activity-search')?.value || '').toLowerCase();
      const unit = String(document.getElementById('activity-unit-filter')?.value || '').trim().toLowerCase();
      list.innerHTML = '';
      const items = activitiesData.filter(a => {
        const hay = `${(a.title||'')} ${(a.category||'')} ${(a.unit||'')} ${(Array.isArray(a.tags)?a.tags.join(' '):'')}`.toLowerCase();
        const okQ = !q || hay.includes(q);
        const okU = !unit || String(a.unit||'').toLowerCase() === unit;
        return okQ && okU;
      });
      if (!items.length){ list.innerHTML = '<li>����������Ȃ��K�ɗ����͂���܂���</li>'; return; }
      for (const a of items){
        const li = document.createElement('li');
        li.className = 'news-item';
        const dateStr = a.activity_date ? formatDate(a.activity_date) : '';
        const unitStr = a.unit ? escapeHTML(a.unit) : '';
        const catStr = a.category ? escapeHTML(a.category) : '';
        const tagsStr = Array.isArray(a.tags) && a.tags.length ? '#' + a.tags.join(' #') : '';
        li.innerHTML = `
          <span class="news-item-title">${escapeHTML(a.title)}</span>
          <span class="inline-block text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${catStr || '������'}</span>
          ${unitStr ? `<span class=\"inline-block text-xs px-2 py-1 rounded bg-gray-100 text-gray-700\">${unitStr}</span>` : ''}
          ${dateStr ? `<span class=\"inline-block text-xs px-2 py-1 rounded bg-gray-100 text-gray-700\">${dateStr}</span>` : ''}
          ${tagsStr ? `<div class=\"text-xs text-gray-500 mt-1\">${escapeHTML(tagsStr)}</div>` : ''}
          <div class="news-item-actions">
            <a href="/activity-log.html" target="_blank" rel="noopener"><button class="btn-ghost">公開ページ</button></a>
            <a href="/admin/activity-edit.html?id=${a.id}"><button>編集</button></a>
            <button class="danger" data-action="delete" data-id="${a.id}">削除</button>
          </div>
        `;
        list.appendChild(li);
      }
    }
    async function ensureActivitiesLoaded(){
      if (!activitiesLoaded){ await Promise.all([loadUnitsToFilter(), loadActivities()]); activitiesLoaded = true; }
      renderActivities();
    }
    function setupActivityFilters(){
      const s = document.getElementById('activity-search');
      const u = document.getElementById('activity-unit-filter');
      s?.addEventListener('input', renderActivities);
      u?.addEventListener('change', renderActivities);
      document.getElementById('activity-list')?.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-action="delete"]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('この活動を削除しますか？')) return;
        try {
          const res = await fetch(`/api/activities/${id}`, { method: 'DELETE', credentials: 'same-origin' });
          if (!res.ok) throw new Error('failed');
          activitiesData = activitiesData.filter(x => String(x.id) !== String(id));
          renderActivities();
        } catch {
          AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" });
        }
      });
    }

    function setupDraftToolbar(){
      const DKEY = 'admin_settings_draft';
      const saveBtn = document.getElementById('btn-save-draft');
      const restoreBtn = document.getElementById('btn-restore-draft');
      const discardBtn = document.getElementById('btn-discard-draft');
      const importBtn = document.getElementById('btn-import-task');

      saveBtn?.addEventListener('click', () => {
        const payload = {};
        document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(el => { if (el.name) payload[el.name] = el.value; });
        localStorage.setItem(DKEY, JSON.stringify(payload));
        AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" });
      });
      restoreBtn?.addEventListener('click', () => {
        const txt = localStorage.getItem(DKEY);
        if (!txt) return AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" });
        const data = JSON.parse(txt);
        applyPayloadToForm(data);
        setupUrlPreviews();
        AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" });
      });
      discardBtn?.addEventListener('click', () => {
        localStorage.removeItem(DKEY);
        AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" });
      });
      importBtn?.addEventListener('click', () => {
        const sample = '例:\nbeaver https://...\ncub https://...\nboy https://...\nventure https://...\nrover https://...\n団章 https://...';
        const text = prompt('task.txt の内容を貼り付けてください\n' + sample, '');
        if (!text) return;
        const map = {};
        text.split(/\r?\n/).forEach(line => {
          const t = line.trim(); if (!t || t.startsWith('#')) return;
          const m = t.split(/\s+/, 2); if (m.length<2) return;
          map[m[0].toLowerCase()] = m[1];
        });
        const setIf = (name, key) => { if (map[key]) { const el = document.getElementById(name); if (el) el.value = map[key]; } };
        setIf('unit_beaver_logo_url','beaver');
        setIf('unit_cub_logo_url','cub');
        setIf('unit_boy_logo_url','boy');
        setIf('unit_venture_logo_url','venture');
        setIf('unit_rover_logo_url','rover');
        setIf('group_crest_url','団章'); setIf('group_crest_url','dan'); setIf('group_crest_url','group'); setIf('group_crest_url','crest');
        setupUrlPreviews();
        AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" });
      });
    }

    function setupDirtyGuard(){
      let dirty = false;
      const mark = () => { dirty = true; };
      document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(el => el.addEventListener('input', mark));
      window.addEventListener('beforeunload', (e) => { if (dirty) { e.preventDefault(); e.returnValue = ''; } });
      const form = document.getElementById('settings-form');
      form?.addEventListener('submit', () => { dirty = false; });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await ensureLoggedIn();
      // 旧タブは非表示。新しい右メニュー/左ペインUIを初期化
      initSideMenu();
      // 初期値ロード
      try {
        const res = await fetch('/api/settings/all', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('fetch settings failed');
        const rows = await res.json();
        const settings = rows.reduce((acc, r) => { acc[r.key] = r.value; return acc; }, {});
        fillForm(settings);
      } catch (e) {
        document.getElementById('error-message').textContent = '設定の読み込みに失敗しました。';
      }

      // 補助機能
      setupUrlPreviews();
      setupDraftToolbar();
      setupDirtyGuard();
      setupActivityFilters();

      // 文字化け対策：表示テキストを明示的に上書き
      try {
        const byId = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
        byId('btn-save-draft', '下書き保存');
        byId('btn-restore-draft', '下書きを復元');
        byId('btn-discard-draft', '下書きを破棄');
        byId('btn-import-task', 'task.txt から取り込み');

        const aside = document.querySelector('.side-menu');
        if (aside) aside.setAttribute('aria-label', '設定カテゴリ');
        const asideTitle = document.querySelector('.side-menu h3');
        if (asideTitle) asideTitle.textContent = '大枠の設定';

        // 旧タブUIの文言（非表示だが念のため）
        document.querySelectorAll('#settings-tabs [data-tab]').forEach(btn => {
          const map = {
            contact: '連絡先', privacy: 'プライバシー', leader_names: 'リーダー名', branding: 'ブランディング',
            leader_profile: 'リーダー写真/メッセージ', gallery: 'ギャラリー', top_images: 'トップ画像', activity: '活動管理'
          };
          const key = btn.getAttribute('data-tab');
          if (map[key]) btn.textContent = map[key];
        });

        // 活動検索UI
        const kw = document.getElementById('activity-search'); if (kw) kw.placeholder = 'キーワードで検索...';
        const sel = document.getElementById('activity-unit-filter'); if (sel) sel.setAttribute('aria-label', '隊フィルター');
        const firstOpt = document.querySelector('#activity-unit-filter option'); if (firstOpt) firstOpt.textContent = 'すべての隊';
        const newBtn = document.querySelector('#tab-activity .btn.btn-secondary'); if (newBtn) newBtn.textContent = '新規作成';

        // ヘッダー/タイトル
        document.title = 'サイト設定 - 管理';
        const h1 = document.querySelector('.header h1'); if (h1) h1.textContent = 'サイト設定';
        const backBtn = document.querySelector('.header a[href="dashboard.html"] button'); if (backBtn) backBtn.textContent = 'ダッシュボードへ戻る';
        const logoutBtn = document.getElementById('logout-button'); if (logoutBtn) logoutBtn.textContent = 'ログアウト';

        // フォームアクション
        const submitBtn = document.querySelector('.form-actions button[type="submit"]'); if (submitBtn) submitBtn.textContent = '保存';
        const cancelBtn = document.querySelector('.form-actions a button[type="button"]'); if (cancelBtn) cancelBtn.textContent = 'キャンセル';
        const okMsg = document.getElementById('save-message'); if (okMsg) okMsg.textContent = '保存しました。';
      } catch {}

      // UX向上: Ctrl/Cmd + S で保存
      const form = document.getElementById('settings-form');
      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
          e.preventDefault();
          form?.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
      });

      // 上部ツールバーの保存/キャンセルを連携
      document.getElementById('btn-save-top')?.addEventListener('click', () => {
        form?.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
      });

      // ヘルプモーダル
      const helpBtn = document.getElementById('btn-help');
      const helpBackdrop = document.createElement('div');
      helpBackdrop.className = 'modal-backdrop';
      helpBackdrop.id = 'help-backdrop';
      helpBackdrop.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
          <div class="modal-header"><h3 id="help-title">ヘルプ</h3></div>
          <div class="modal-body">
            <p>操作のコツ:</p>
            <ul>
              <li>Ctrl/Cmd + S で保存</li>
              <li>右メニューでカテゴリ切替、左で項目を編集</li>
              <li>URL欄は画像プレビューが表示されます</li>
            </ul>
          </div>
          <div class="actions"><button class="btn" id="help-close">閉じる</button></div>
        </div>`;
      document.body.appendChild(helpBackdrop);
      helpBtn?.addEventListener('click', () => { helpBackdrop.classList.add('open'); });
      helpBackdrop?.addEventListener('click', (e) => {
        if (e.target === helpBackdrop || (e.target && e.target.id === 'help-close')) helpBackdrop.classList.remove('open');
      });

      // サイドメニュー（モバイル）開閉 + バックドロップ
      const sideMenu = document.querySelector('.side-menu');
      const sideBackdrop = document.getElementById('side-backdrop');
      const menuToggle = document.getElementById('menu-toggle');
      const openMenu = () => { sideMenu?.classList.add('open'); sideBackdrop?.classList.add('open'); };
      const closeMenu = () => { sideMenu?.classList.remove('open'); sideBackdrop?.classList.remove('open'); };
      menuToggle?.addEventListener('click', openMenu);
      sideBackdrop?.addEventListener('click', closeMenu);
      // メニュー項目クリックで閉じる（モバイル）
      document.getElementById('menu-list')?.addEventListener('click', (e) => {
        if (window.matchMedia('(max-width: 980px)').matches && e.target.closest('.menu-btn')) closeMenu();
      });

      // メニュー検索
      const menuSearch = document.getElementById('menu-search');
      menuSearch?.addEventListener('input', () => {
        const q = (menuSearch.value || '').toLowerCase();
        document.querySelectorAll('#menu-list .menu-btn').forEach(btn => {
          const hit = (btn.textContent || '').toLowerCase().includes(q);
          btn.style.display = hit ? '' : 'none';
        });
      });

      // 保存
      document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errEl = document.getElementById('error-message');
        const okEl = document.getElementById('save-message');
        errEl.textContent = '';
        okEl.style.display = 'none';

        const payload = {};
        document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(input => {
          if (input.name) payload[input.name] = input.value;
        });

        try {
          const res = await fetch('/api/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || '保存に失敗しました');
          }
          okEl.style.display = 'block';
          setTimeout(() => okEl.style.display = 'none', 2000); if (window.AdminUI) { AdminUI.showResult({ ok:true, message: '設定を保存しました', actions:[{ label:'閉じる', variant:'primary' }] }); }
        } catch (e) { errEl.textContent = e.message || '保存に失敗しました。'; if (window.AdminUI) { AdminUI.showResult({ ok:false, message: '設定の保存に失敗しました', detail: e.message }); } }});

      // ログアウト
      document.getElementById('logout-button').addEventListener('click', async () => {
        try { await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' }); window.location.href = '/admin/login.html'; }
        catch { AdminUI.showResult({ ok:false, message: "活動の削除に失敗しました" }); }
      });
    });
  </script>
</body>
</html>



