<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サイト設定 - 管理</title>
  <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
  <div class="header">
    <h1>サイト設定</h1>
    <div>
      <a href="dashboard.html"><button>ダッシュボードへ戻る</button></a>
      <button id="logout-button">ログアウト</button>
    </div>
  </div>

  <div class="container">
    <form id="settings-form">
      <style>
        .tabs { display:flex; gap:8px; border-bottom:1px solid var(--admin-border); margin-bottom:14px; flex-wrap:wrap; }
        .tab-btn { background:#fff; border:1px solid var(--admin-border); border-bottom:none; padding:8px 12px; border-top-left-radius:8px; border-top-right-radius:8px; cursor:pointer; color:var(--admin-text); }
        .tab-btn.active { background: var(--admin-primary-50, #eef7f1); color: var(--admin-primary-700, #0b6b3a); border-color: var(--admin-primary-200, #bfe3cc); font-weight:600; }
        .tab-panel { display:none; background:#fff; border:1px solid var(--admin-border); border-radius:0 8px 8px 8px; padding:16px; box-shadow: var(--admin-shadow); }
        .tab-panel.active { display:block; }
        .panel-columns { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 860px) { .panel-columns { grid-template-columns: 1fr; } }
        .toolbar { display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 10px; }
        .toolbar .btn { background:#fff; color: var(--admin-text); border:1px solid var(--admin-border); padding:8px 12px; border-radius:8px; cursor:pointer; }
        .form-group.invalid input { border-color: var(--admin-danger); }
        .hint { color: var(--admin-text-muted); font-size: 12px; margin-top: 4px; }
        .img-preview { border:1px dashed var(--admin-border); padding:8px; border-radius:8px; background:#fafafa; margin-top:6px; display:none; }
        .img-preview img { max-width:100%; height:auto; display:block; }
      </style>

      <nav class="tabs" id="settings-tabs">
        <button type="button" class="tab-btn" data-tab="contact">基本情報</button>
        <button type="button" class="tab-btn" data-tab="privacy">プライバシー</button>
        <button type="button" class="tab-btn" data-tab="leader_names">リーダー名</button>
        <button type="button" class="tab-btn" data-tab="branding">ブランディング</button>
        <button type="button" class="tab-btn" data-tab="leader_profile">リーダー写真/メッセージ</button>
        <button type="button" class="tab-btn" data-tab="gallery">ギャラリー</button>
        <button type="button" class="tab-btn" data-tab="top_images">トップ画像</button>
        <button type="button" class="tab-btn" data-tab="activity">�K�ɗ���</button>
      </nav>

      <div class="toolbar">
        <button type="button" class="btn" id="btn-save-draft">下書きを保存</button>
        <button type="button" class="btn" id="btn-restore-draft">下書きを復元</button>
        <button type="button" class="btn" id="btn-discard-draft">下書きを破棄</button>
        <button type="button" class="btn" id="btn-import-task">task.txt取り込み</button>
      </div>

      <div id="tab-contact" class="tab-panel"><div class="panel-columns" data-fields="contact"></div></div>
      <div id="tab-privacy" class="tab-panel"><div class="panel-columns" data-fields="privacy"></div></div>
      <div id="tab-leader_names" class="tab-panel"><div class="panel-columns" data-fields="leader_names"></div></div>
      <div id="tab-branding" class="tab-panel"><div class="panel-columns" data-fields="branding"></div></div>
      <div id="tab-leader_profile" class="tab-panel"><div class="panel-columns" data-fields="leader_profile"></div></div>
      <div id="tab-gallery" class="tab-panel"><div class="panel-columns" data-fields="gallery"></div></div>
      <div id="tab-top_images" class="tab-panel"><div class="panel-columns" data-fields="top_images"></div></div>
      <div id="tab-activity" class="tab-panel">
        <div class="toolbar" style="margin-top:0; display:flex; gap:8px; align-items:center;">
          <input type="search" id="activity-search" placeholder="活動を検索..." aria-label="活動 検索" style="flex:1;min-width:220px">
          <select id="activity-unit-filter" aria-label="隊フィルター">
            <option value="">すべての隊</option>
          </select>
          <a href="activity-edit.html"><button type="button" class="btn btn-secondary">新規作成</button></a>
        </div>
        <ul id="activity-list" class="news-list"></ul>
        <p id="activity-error" class="error-message"></p>
      </div>
      <h2>連絡先・共通情報</h2>
      <div class="form-group">
        <label for="contact_address">住所</label>
        <input type="text" id="contact_address" name="contact_address" placeholder="〒XXX-XXXX 岐阜県多治見市XX町X-X-X">
      </div>
      <div class="form-group">
        <label for="contact_phone">電話番号（代表）</label>
        <input type="text" id="contact_phone" name="contact_phone" placeholder="0572-XX-XXXX">
      </div>
      <div class="form-group">
        <label for="contact_secondary_phone">電話番号（サブ）</label>
        <input type="text" id="contact_secondary_phone" name="contact_secondary_phone" placeholder="0572-00-0000 など">
      </div>
      <div class="form-group">
        <label for="contact_email">メールアドレス</label>
        <input type="email" id="contact_email" name="contact_email" placeholder="info@bs-tajimi1.example.jp">
      </div>
      <div class="form-group">
        <label for="contact_person_name">お問い合わせ担当者名</label>
        <input type="text" id="contact_person_name" name="contact_person_name" placeholder="担当者名">
      </div>

      <h2>プライバシーポリシー表示項目</h2>
      <div class="form-group">
        <label for="privacy_contact_person">窓口担当（氏名・役職）</label>
        <input type="text" id="privacy_contact_person" name="privacy_contact_person" placeholder="例）団委員長 ○○ ○○">
      </div>
      <div class="form-group">
        <label for="privacy_contact_phone">窓口電話番号</label>
        <input type="text" id="privacy_contact_phone" name="privacy_contact_phone" placeholder="電話番号を記載">
      </div>
      <div class="form-group">
        <label for="privacy_contact_email">窓口メールアドレス</label>
        <input type="email" id="privacy_contact_email" name="privacy_contact_email" placeholder="メールアドレスを記載">
      </div>
      <div class="form-group">
        <label for="privacy_effective_date">制定日</label>
        <input type="text" id="privacy_effective_date" name="privacy_effective_date" placeholder="例）2025年5月12日">
      </div>
      <div class="form-group">
        <label for="privacy_last_updated_date">最終更新日</label>
        <input type="text" id="privacy_last_updated_date" name="privacy_last_updated_date" placeholder="例）2025年5月12日">
      </div>

      <h2>各隊リーダー名</h2>
      <div class="form-group"><label for="leader_beaver">ビーバー隊リーダー</label><input type="text" id="leader_beaver" name="leader_beaver" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_cub">カブ隊リーダー</label><input type="text" id="leader_cub" name="leader_cub" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_boy">ボーイ隊隊長</label><input type="text" id="leader_boy" name="leader_boy" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_venture">ベンチャー隊隊長</label><input type="text" id="leader_venture" name="leader_venture" placeholder="氏名"></div>
      <div class="form-group"><label for="leader_rover">ローバー隊アドバイザー</label><input type="text" id="leader_rover" name="leader_rover" placeholder="氏名"></div>

      <h2>トップページ画像URL</h2>
      <div class="form-group"><label for="index_hero_image_url">ヒーロー画像URL</label><input type="text" id="index_hero_image_url" name="index_hero_image_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_highlight_img_1_url">活動ハイライト1</label><input type="text" id="index_highlight_img_1_url" name="index_highlight_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_highlight_img_2_url">活動ハイライト2</label><input type="text" id="index_highlight_img_2_url" name="index_highlight_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_highlight_img_3_url">活動ハイライト3</label><input type="text" id="index_highlight_img_3_url" name="index_highlight_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_testimonial_img_1_url">プロフィール画像1</label><input type="text" id="index_testimonial_img_1_url" name="index_testimonial_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="index_testimonial_img_2_url">プロフィール画像2</label><input type="text" id="index_testimonial_img_2_url" name="index_testimonial_img_2_url" placeholder="https://..."></div>

      <h2>お問い合わせページ</h2>
      <div class="form-group">
        <label for="contact_map_embed_html">Googleマップ埋め込みHTML</label>
        <textarea id="contact_map_embed_html" name="contact_map_embed_html" rows="5" placeholder="&lt;iframe ...&gt;&lt;/iframe&gt;"></textarea>
      </div>

      <h2>団章・各隊ロゴ URL</h2>
      <div class="form-group"><label for="group_crest_url">団章（ヘッダー/フッター）</label><input type="text" id="group_crest_url" name="group_crest_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_logo_url">ビーバー隊章（ロゴ）</label><input type="text" id="unit_beaver_logo_url" name="unit_beaver_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_logo_url">カブ隊章（ロゴ）</label><input type="text" id="unit_cub_logo_url" name="unit_cub_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_logo_url">ボーイ隊章（ロゴ）</label><input type="text" id="unit_boy_logo_url" name="unit_boy_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_logo_url">ベンチャー隊章（ロゴ）</label><input type="text" id="unit_venture_logo_url" name="unit_venture_logo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_logo_url">ローバー隊章（ロゴ）</label><input type="text" id="unit_rover_logo_url" name="unit_rover_logo_url" placeholder="https://..."></div>

      <h2>各隊 リーダー写真・メッセージ</h2>
      <div class="form-group"><label for="unit_beaver_leader_photo_url">ビーバー リーダー写真URL</label><input type="text" id="unit_beaver_leader_photo_url" name="unit_beaver_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_leader_message">ビーバー メッセージ</label><textarea id="unit_beaver_leader_message" name="unit_beaver_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_cub_leader_photo_url">カブ リーダー写真URL</label><input type="text" id="unit_cub_leader_photo_url" name="unit_cub_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_leader_message">カブ メッセージ</label><textarea id="unit_cub_leader_message" name="unit_cub_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_boy_leader_photo_url">ボーイ リーダー写真URL</label><input type="text" id="unit_boy_leader_photo_url" name="unit_boy_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_leader_message">ボーイ メッセージ</label><textarea id="unit_boy_leader_message" name="unit_boy_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_venture_leader_photo_url">ベンチャー リーダー写真URL</label><input type="text" id="unit_venture_leader_photo_url" name="unit_venture_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_leader_message">ベンチャー メッセージ</label><textarea id="unit_venture_leader_message" name="unit_venture_leader_message" rows="3" placeholder="メッセージ"></textarea></div>
      <div class="form-group"><label for="unit_rover_leader_photo_url">ローバー リーダー写真URL</label><input type="text" id="unit_rover_leader_photo_url" name="unit_rover_leader_photo_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_leader_message">ローバー メッセージ</label><textarea id="unit_rover_leader_message" name="unit_rover_leader_message" rows="3" placeholder="メッセージ"></textarea></div>

      <h2>各隊 ギャラリー画像URL（最大4枚）</h2>
      <h3>ビーバー</h3>
      <div class="form-group"><label for="unit_beaver_gallery_img_1_url">画像1</label><input type="text" id="unit_beaver_gallery_img_1_url" name="unit_beaver_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_gallery_img_2_url">画像2</label><input type="text" id="unit_beaver_gallery_img_2_url" name="unit_beaver_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_gallery_img_3_url">画像3</label><input type="text" id="unit_beaver_gallery_img_3_url" name="unit_beaver_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_beaver_gallery_img_4_url">画像4</label><input type="text" id="unit_beaver_gallery_img_4_url" name="unit_beaver_gallery_img_4_url" placeholder="https://..."></div>
      <h3>カブ</h3>
      <div class="form-group"><label for="unit_cub_gallery_img_1_url">画像1</label><input type="text" id="unit_cub_gallery_img_1_url" name="unit_cub_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_gallery_img_2_url">画像2</label><input type="text" id="unit_cub_gallery_img_2_url" name="unit_cub_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_gallery_img_3_url">画像3</label><input type="text" id="unit_cub_gallery_img_3_url" name="unit_cub_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_cub_gallery_img_4_url">画像4</label><input type="text" id="unit_cub_gallery_img_4_url" name="unit_cub_gallery_img_4_url" placeholder="https://..."></div>
      <h3>ボーイ</h3>
      <div class="form-group"><label for="unit_boy_gallery_img_1_url">画像1</label><input type="text" id="unit_boy_gallery_img_1_url" name="unit_boy_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_gallery_img_2_url">画像2</label><input type="text" id="unit_boy_gallery_img_2_url" name="unit_boy_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_gallery_img_3_url">画像3</label><input type="text" id="unit_boy_gallery_img_3_url" name="unit_boy_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_boy_gallery_img_4_url">画像4</label><input type="text" id="unit_boy_gallery_img_4_url" name="unit_boy_gallery_img_4_url" placeholder="https://..."></div>
      <h3>ベンチャー</h3>
      <div class="form-group"><label for="unit_venture_gallery_img_1_url">画像1</label><input type="text" id="unit_venture_gallery_img_1_url" name="unit_venture_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_gallery_img_2_url">画像2</label><input type="text" id="unit_venture_gallery_img_2_url" name="unit_venture_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_gallery_img_3_url">画像3</label><input type="text" id="unit_venture_gallery_img_3_url" name="unit_venture_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_venture_gallery_img_4_url">画像4</label><input type="text" id="unit_venture_gallery_img_4_url" name="unit_venture_gallery_img_4_url" placeholder="https://..."></div>
      <h3>ローバー</h3>
      <div class="form-group"><label for="unit_rover_gallery_img_1_url">画像1</label><input type="text" id="unit_rover_gallery_img_1_url" name="unit_rover_gallery_img_1_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_gallery_img_2_url">画像2</label><input type="text" id="unit_rover_gallery_img_2_url" name="unit_rover_gallery_img_2_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_gallery_img_3_url">画像3</label><input type="text" id="unit_rover_gallery_img_3_url" name="unit_rover_gallery_img_3_url" placeholder="https://..."></div>
      <div class="form-group"><label for="unit_rover_gallery_img_4_url">画像4</label><input type="text" id="unit_rover_gallery_img_4_url" name="unit_rover_gallery_img_4_url" placeholder="https://..."></div>

      <div class="form-actions">
        <button type="submit">保存</button>
        <a href="dashboard.html"><button type="button">キャンセル</button></a>
      </div>
      <p id="save-message" class="success-message" style="display:none;">保存しました。</p>
      <p id="error-message" class="error-message"></p>
    </form>
  </div>

  <script>
    async function ensureLoggedIn() {
      try {
        const r = await fetch('/api/session');
        const d = await r.json();
        if (!d.loggedIn) { window.location.href = '/admin/login.html'; }
      } catch { window.location.href = '/admin/login.html'; }
    }

    function fillForm(settings) {
      const fields = [
        'contact_address','contact_phone','contact_secondary_phone','contact_email','contact_person_name',
        'privacy_contact_person','privacy_contact_phone','privacy_contact_email','privacy_effective_date','privacy_last_updated_date',
        'leader_beaver','leader_cub','leader_boy','leader_venture','leader_rover',
        'index_hero_image_url','index_highlight_img_1_url','index_highlight_img_2_url','index_highlight_img_3_url',
        'index_testimonial_img_1_url','index_testimonial_img_2_url','contact_map_embed_html'
      ];
      fields.forEach(k => {
        const el = document.getElementById(k);
        if (!el) return;
        el.value = settings[k] || '';
      });

      // 追加フィールドも一括反映（name/id が設定キーと同じもの）
      document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(el => {
        const key = el.name || el.id;
        if (!key) return;
        if (typeof settings[key] !== 'undefined') {
          el.value = settings[key];
        }
      });
    }

    function initTabs() {
      const tabButtons = Array.from(document.querySelectorAll('#settings-tabs .tab-btn'));
      const panels = {
        contact: document.querySelector('#tab-contact [data-fields]'),
        privacy: document.querySelector('#tab-privacy [data-fields]'),
        leader_names: document.querySelector('#tab-leader_names [data-fields]'),
        branding: document.querySelector('#tab-branding [data-fields]'),
        leader_profile: document.querySelector('#tab-leader_profile [data-fields]'),
        gallery: document.querySelector('#tab-gallery [data-fields]'),
        top_images: document.querySelector('#tab-top_images [data-fields]'),
      };

      const groups = new Map([
        ['contact', ['contact_address','contact_phone','contact_secondary_phone','contact_email','contact_person_name','contact_map_embed_html']],
        ['privacy', ['privacy_contact_person','privacy_contact_phone','privacy_contact_email','privacy_effective_date','privacy_last_updated_date']],
        ['leader_names', ['leader_beaver','leader_cub','leader_boy','leader_venture','leader_rover']],
        ['branding', ['group_crest_url','unit_beaver_logo_url','unit_cub_logo_url','unit_boy_logo_url','unit_venture_logo_url','unit_rover_logo_url']],
        ['leader_profile', [
          'unit_beaver_leader_photo_url','unit_beaver_leader_message',
          'unit_cub_leader_photo_url','unit_cub_leader_message',
          'unit_boy_leader_photo_url','unit_boy_leader_message',
          'unit_venture_leader_photo_url','unit_venture_leader_message',
          'unit_rover_leader_photo_url','unit_rover_leader_message'
        ]],
        ['gallery', [
          'unit_beaver_gallery_img_1_url','unit_beaver_gallery_img_2_url','unit_beaver_gallery_img_3_url','unit_beaver_gallery_img_4_url',
          'unit_cub_gallery_img_1_url','unit_cub_gallery_img_2_url','unit_cub_gallery_img_3_url','unit_cub_gallery_img_4_url',
          'unit_boy_gallery_img_1_url','unit_boy_gallery_img_2_url','unit_boy_gallery_img_3_url','unit_boy_gallery_img_4_url',
          'unit_venture_gallery_img_1_url','unit_venture_gallery_img_2_url','unit_venture_gallery_img_3_url','unit_venture_gallery_img_4_url',
          'unit_rover_gallery_img_1_url','unit_rover_gallery_img_2_url','unit_rover_gallery_img_3_url','unit_rover_gallery_img_4_url'
        ]],
        ['top_images', ['index_hero_image_url','index_highlight_img_1_url','index_highlight_img_2_url','index_highlight_img_3_url','index_testimonial_img_1_url','index_testimonial_img_2_url']],
      ]);

      // move groups into panels
      groups.forEach((ids, key) => {
        const container = panels[key];
        if (!container) return;
        ids.forEach(id => {
          const input = document.getElementById(id);
          if (!input) return;
          const group = input.closest('.form-group') || input.parentElement;
          if (group && !container.contains(group)) container.appendChild(group);
        });
      });

      // hide original headings
      document.querySelectorAll('#settings-form h2, #settings-form h3').forEach(h => {
        if (!h.closest('.tab-panel')) h.style.display = 'none';
      });

      function activate(tab) {
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + tab));
        localStorage.setItem('admin_settings_active_tab', tab);
        if (tab === 'activity') { ensureActivitiesLoaded(); }
      }
      const params = new URLSearchParams(location.search);
      const initial = params.get('tab') || localStorage.getItem('admin_settings_active_tab') || 'contact';
      activate(initial);
      tabButtons.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));
    }

    function isUrl(str){ try { const u = new URL(str); return u.protocol === 'http:' || u.protocol === 'https:'; } catch { return false; } }
    function setupUrlPreviews(){
      const inputs = Array.from(document.querySelectorAll('#settings-form input[type="text"], #settings-form input[type="url"]'));
      inputs.forEach(input => {
        const key = input.name || input.id || '';
        if (!key.endsWith('_url') && key !== 'group_crest_url') return;
        let preview = input.parentElement.querySelector('.img-preview');
        if (!preview){ preview = document.createElement('div'); preview.className='img-preview'; preview.innerHTML='<img alt="preview"><div class="hint"><a class="open-link" target="_blank" rel="noopener">新しいタブで開く</a></div>'; input.parentElement.appendChild(preview); }
        const img = preview.querySelector('img');
        const link = preview.querySelector('.open-link');
        const update = () => {
          const v = (input.value || '').trim();
          if (v && isUrl(v)) { img.src = v; link.href = v; preview.style.display='block'; input.parentElement.classList.remove('invalid'); }
          else { preview.style.display='none'; if (v) input.parentElement.classList.add('invalid'); else input.parentElement.classList.remove('invalid'); }
        };
        input.addEventListener('input', update);
        update();
      });
    }

    function applyPayloadToForm(payload){
      Object.entries(payload || {}).forEach(([k,v]) => {
        const el = document.querySelector(`#settings-form [name="${k}"]`) || document.getElementById(k);
        if (el) el.value = v;
      });
    }

    // ---- Activity viewer (read-only) ----
    let activitiesLoaded = false;
    let activitiesData = [];
    function escapeHTML(str){
      return String(str||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
    function formatDate(iso){ try { const d = new Date(iso); if (isNaN(d)) return ''; return d.toLocaleDateString('ja-JP'); } catch { return ''; } }
    async function loadActivities(){
      try {
        const res = await fetch('/api/activities?limit=200');
        if (!res.ok) throw new Error('failed');
        activitiesData = await res.json();
      } catch (e) {
        const err = document.getElementById('activity-error');
        if (err) err.textContent = '�K�ɗ���̓ǂݍ��݂Ɏ��s���܂����B';
        activitiesData = [];
      }
    }
    async function loadUnitsToFilter(){
      try {
        const r = await fetch('/api/settings/all');
        if (!r.ok) return;
        const rows = await r.json();
        const map = rows.reduce((acc, it) => (acc[it.key] = it.value, acc), {});
        const units = JSON.parse(map.units_json || '[]');
        const sel = document.getElementById('activity-unit-filter');
        if (sel) {
          sel.innerHTML = '<option value="">すべての隊</option>' + (Array.isArray(units)?units.map(u=>`<option value="${(u.slug||'').toString()}">${(u.label||u.slug||'').toString()}</option>`).join(''): '');
        }
      } catch {}
    }
    function renderActivities(){
      const list = document.getElementById('activity-list'); if (!list) return;
      const q = String(document.getElementById('activity-search')?.value || '').toLowerCase();
      const unit = String(document.getElementById('activity-unit-filter')?.value || '').trim().toLowerCase();
      list.innerHTML = '';
      const items = activitiesData.filter(a => {
        const hay = `${(a.title||'')} ${(a.category||'')} ${(a.unit||'')} ${(Array.isArray(a.tags)?a.tags.join(' '):'')}`.toLowerCase();
        const okQ = !q || hay.includes(q);
        const okU = !unit || String(a.unit||'').toLowerCase() === unit;
        return okQ && okU;
      });
      if (!items.length){ list.innerHTML = '<li>����������Ȃ��K�ɗ����͂���܂���</li>'; return; }
      for (const a of items){
        const li = document.createElement('li');
        li.className = 'news-item';
        const dateStr = a.activity_date ? formatDate(a.activity_date) : '';
        const unitStr = a.unit ? escapeHTML(a.unit) : '';
        const catStr = a.category ? escapeHTML(a.category) : '';
        const tagsStr = Array.isArray(a.tags) && a.tags.length ? '#' + a.tags.join(' #') : '';
        li.innerHTML = `
          <span class="news-item-title">${escapeHTML(a.title)}</span>
          <span class="inline-block text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${catStr || '������'}</span>
          ${unitStr ? `<span class=\"inline-block text-xs px-2 py-1 rounded bg-gray-100 text-gray-700\">${unitStr}</span>` : ''}
          ${dateStr ? `<span class=\"inline-block text-xs px-2 py-1 rounded bg-gray-100 text-gray-700\">${dateStr}</span>` : ''}
          ${tagsStr ? `<div class=\"text-xs text-gray-500 mt-1\">${escapeHTML(tagsStr)}</div>` : ''}
          <div class="news-item-actions">
            <a href="/activity-log.html" target="_blank" rel="noopener"><button class="btn-ghost">公開ページ</button></a>
            <a href="/admin/activity-edit.html?id=${a.id}"><button>編集</button></a>
            <button class="danger" data-action="delete" data-id="${a.id}">削除</button>
          </div>
        `;
        list.appendChild(li);
      }
    }
    async function ensureActivitiesLoaded(){
      if (!activitiesLoaded){ await Promise.all([loadUnitsToFilter(), loadActivities()]); activitiesLoaded = true; }
      renderActivities();
    }
    function setupActivityFilters(){
      const s = document.getElementById('activity-search');
      const u = document.getElementById('activity-unit-filter');
      s?.addEventListener('input', renderActivities);
      u?.addEventListener('change', renderActivities);
      document.getElementById('activity-list')?.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-action="delete"]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('この活動を削除しますか？')) return;
        try {
          const res = await fetch(`/api/activities/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('failed');
          activitiesData = activitiesData.filter(x => String(x.id) !== String(id));
          renderActivities();
        } catch {
          alert('削除に失敗しました');
        }
      });
    }

    function setupDraftToolbar(){
      const DKEY = 'admin_settings_draft';
      const saveBtn = document.getElementById('btn-save-draft');
      const restoreBtn = document.getElementById('btn-restore-draft');
      const discardBtn = document.getElementById('btn-discard-draft');
      const importBtn = document.getElementById('btn-import-task');

      saveBtn?.addEventListener('click', () => {
        const payload = {};
        document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(el => { if (el.name) payload[el.name] = el.value; });
        localStorage.setItem(DKEY, JSON.stringify(payload));
        alert('下書きを保存しました');
      });
      restoreBtn?.addEventListener('click', () => {
        const txt = localStorage.getItem(DKEY);
        if (!txt) return alert('下書きがありません');
        const data = JSON.parse(txt);
        applyPayloadToForm(data);
        setupUrlPreviews();
        alert('下書きを復元しました');
      });
      discardBtn?.addEventListener('click', () => {
        localStorage.removeItem(DKEY);
        alert('下書きを破棄しました');
      });
      importBtn?.addEventListener('click', () => {
        const sample = '例:\nbeaver https://...\ncub https://...\nboy https://...\nventure https://...\nrover https://...\n団章 https://...';
        const text = prompt('task.txt の内容を貼り付けてください\n' + sample, '');
        if (!text) return;
        const map = {};
        text.split(/\r?\n/).forEach(line => {
          const t = line.trim(); if (!t || t.startsWith('#')) return;
          const m = t.split(/\s+/, 2); if (m.length<2) return;
          map[m[0].toLowerCase()] = m[1];
        });
        const setIf = (name, key) => { if (map[key]) { const el = document.getElementById(name); if (el) el.value = map[key]; } };
        setIf('unit_beaver_logo_url','beaver');
        setIf('unit_cub_logo_url','cub');
        setIf('unit_boy_logo_url','boy');
        setIf('unit_venture_logo_url','venture');
        setIf('unit_rover_logo_url','rover');
        setIf('group_crest_url','団章'); setIf('group_crest_url','dan'); setIf('group_crest_url','group'); setIf('group_crest_url','crest');
        setupUrlPreviews();
        alert('task.txtの内容を反映しました');
      });
    }

    function setupDirtyGuard(){
      let dirty = false;
      const mark = () => { dirty = true; };
      document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(el => el.addEventListener('input', mark));
      window.addEventListener('beforeunload', (e) => { if (dirty) { e.preventDefault(); e.returnValue = ''; } });
      const form = document.getElementById('settings-form');
      form?.addEventListener('submit', () => { dirty = false; });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await ensureLoggedIn();
      initTabs();
      // 初期値ロード
      try {
        const res = await fetch('/api/settings/all');
        if (!res.ok) throw new Error('fetch settings failed');
        const rows = await res.json();
        const settings = rows.reduce((acc, r) => { acc[r.key] = r.value; return acc; }, {});
        fillForm(settings);
      } catch (e) {
        document.getElementById('error-message').textContent = '設定の読み込みに失敗しました。';
      }

      // 補助機能
      setupUrlPreviews();
      setupDraftToolbar();
      setupDirtyGuard();
      setupActivityFilters();

      // 保存
      document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errEl = document.getElementById('error-message');
        const okEl = document.getElementById('save-message');
        errEl.textContent = '';
        okEl.style.display = 'none';

        const payload = {};
        document.querySelectorAll('#settings-form input, #settings-form textarea').forEach(input => {
          if (input.name) payload[input.name] = input.value;
        });

        try {
          const res = await fetch('/api/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || '保存に失敗しました');
          }
          okEl.style.display = 'block';
          setTimeout(() => okEl.style.display = 'none', 2000);
        } catch (e) {
          errEl.textContent = e.message || '保存に失敗しました。';
        }
      });

      // ログアウト
      document.getElementById('logout-button').addEventListener('click', async () => {
        try { await fetch('/api/logout', { method: 'POST' }); window.location.href = '/admin/login.html'; }
        catch { alert('ログアウトに失敗しました。'); }
      });
    });
  </script>
</body>
</html>



