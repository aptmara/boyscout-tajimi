/**
 * dynamic-news.js
 * - ニュース一覧/詳細の動的描画
 * - XSS対策のための escapeHTML を使用
 */

document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('news-list-container')) {
    loadDynamicNewsList();
  }
  if (document.getElementById('news-article-container')) {
    loadDynamicNewsDetail();
  }
});

function escapeHTML(str) {
  if (typeof str !== 'string') return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// --- ニュース一覧ページ ---
async function loadDynamicNewsList() {
  const newsListContainer = document.getElementById('news-list-container');
  if (!newsListContainer) return;

  // フィルタUI（IDで取得）を初期状態で非表示
  const filterSection = document.querySelector('#news-filter-section');
  if (filterSection) filterSection.style.display = 'none';

  const newsPaginationContainer = document.getElementById('news-pagination-container');
  const noNewsResultsDiv = document.getElementById('no-news-results');

  const NEWS_ITEMS_PER_PAGE = 5;
  let currentPage = 1;
  let allNews = [];

  function formatDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('ja-JP', options);
  }

  function renderNewsItem(news) {
    const summary = (news.content || '').replace(/<[^>]+>/g, '').substring(0, 100) + '...';
    const detailUrl = `news-detail-placeholder.html?id=${news.id}`;

    const unitBadge = news.unit ? `<span class="badge badge--unit mr-2">${escapeHTML(news.unit)}</span>` : '';
    const catBadge = news.category ? `<span class="badge badge--category">${escapeHTML(news.category)}</span>` : '';
    const tags = Array.isArray(news.tags) ? news.tags : [];
    const tagHtml = tags.slice(0, 6)
      .map(t => `<span class="badge badge--tag">#${escapeHTML(t)}</span>`)
      .join('');

    return `
      <article class="news-item bg-white p-6 rounded-xl shadow-lg border-l-4 border-gray-300 flex flex-col sm:flex-row gap-6 card-hover-effect">
        <div class="sm:w-2/3">
          <a href="${detailUrl}" class="news-item-link group block">
            <div class="flex items-center justify-between mb-2">
              <span>${unitBadge}${catBadge}</span>
              <p class="text-xs text-gray-500">${formatDate(news.created_at)}</p>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2 group-hover:text-green-700 transition-colors duration-300">${escapeHTML(news.title || '')}</h3>
            <p class="text-gray-600 leading-relaxed text-sm line-clamp-2">${escapeHTML(summary)}</p>
            ${tagHtml ? `<div class="flex flex-wrap gap-2 mt-3">${tagHtml}</div>` : ''}
          </a>
        </div>
        <div class="sm:w-1/3 flex sm:flex-col items-end sm:items-start justify-between mt-4 sm:mt-0">
          <a href="${detailUrl}" class="text-sm text-green-600 hover:text-green-800 font-medium transition-colors duration-300 self-end sm:self-start sm:mt-auto">&rarr;</a>
        </div>
      </article>`;
  }

  function renderNewsPagination(totalItems, currentPage) {
    if (!newsPaginationContainer) return;
    const totalPages = Math.ceil(totalItems / NEWS_ITEMS_PER_PAGE);
    if (totalPages <= 1) {
      newsPaginationContainer.innerHTML = '';
      return;
    }
    let html = '<ul class="inline-flex items-center -space-x-px shadow-sm rounded-md">';
    html += `<li><button data-page="${currentPage - 1}" aria-label="前のページへ" class="news-pagination-button pagination-button ${currentPage === 1 ? 'pagination-disabled' : ''}"><span class="sr-only">前へ</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></button></li>`;
    for (let i = 1; i <= totalPages; i++) {
      html += `<li><button data-page="${i}" aria-label="${i}ページ目へ" class="news-pagination-button pagination-button ${i === currentPage ? 'pagination-active' : ''}">${i}</button></li>`;
    }
    html += `<li><button data-page="${currentPage + 1}" aria-label="次のページへ" class="news-pagination-button pagination-button ${currentPage === totalPages ? 'pagination-disabled' : ''}"><span class="sr-only">次へ</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></li>`;
    html += '</ul>';
    newsPaginationContainer.innerHTML = html;
    newsPaginationContainer.querySelectorAll('.news-pagination-button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const page = parseInt(e.currentTarget.dataset.page, 10);
        if (page && page !== currentPage && page > 0 && page <= totalPages) {
          currentPage = page;
          displayNewsItems(allNews);
          if (newsListContainer) newsListContainer.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  }

  function displayNewsItems(arr) {
    newsListContainer.innerHTML = '';
    if (!arr || arr.length === 0) {
      if (noNewsResultsDiv) noNewsResultsDiv.classList.remove('hidden');
      if (newsPaginationContainer) newsPaginationContainer.innerHTML = '';
      return;
    }
    if (noNewsResultsDiv) noNewsResultsDiv.classList.add('hidden');
    const startIndex = (currentPage - 1) * NEWS_ITEMS_PER_PAGE;
    const endIndex = startIndex + NEWS_ITEMS_PER_PAGE;
    const items = arr.slice(startIndex, endIndex);
    items.forEach(n => {
      newsListContainer.innerHTML += renderNewsItem(n);
    });
    renderNewsPagination(arr.length, currentPage);
  }

  try {
    newsListContainer.innerHTML = '<p class="text-center">読み込み中...</p>';
    const qs = window.location.search || '';
    const response = await fetch(`/api/news${qs}`);
    if (!response.ok) throw new Error('Network response was not ok');
    allNews = await response.json();
    displayNewsItems(allNews);
  } catch (err) {
    console.error('Failed to fetch news:', err);
    newsListContainer.innerHTML = '<p class="text-center text-red-500">お知らせの読み込みに失敗しました。</p>';
  }
}

// --- ニュース詳細ページ ---
async function loadDynamicNewsDetail() {
  const articleContainer = document.getElementById('news-article-container');
  if (!articleContainer) return;
  const urlParams = new URLSearchParams(window.location.search);
  const newsId = urlParams.get('id');
  if (!newsId) return;

  const pageTitleElement = document.getElementById('page-title-news');
  const articleNotFoundDiv = document.getElementById('news-article-not-found');

  function formatDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('ja-JP', options);
  }

  try {
    articleContainer.innerHTML = '<p class="text-center">読み込み中...</p>';
    const response = await fetch(`/api/news/${encodeURIComponent(newsId)}`);
    if (!response.ok) throw new Error('Network response was not ok');
    const news = await response.json();
    if (!news || !news.id) throw new Error('Not found');
    if (pageTitleElement) pageTitleElement.textContent = news.title || '';

    const tags = Array.isArray(news.tags) ? news.tags : [];
    const tagBadges = tags.slice(0, 12)
      .map(t => `<span class="badge badge--tag mr-2 mb-2">#${escapeHTML(t)}</span>`)
      .join('');
    const unitBadge = news.unit ? `<span class="badge badge--unit mr-2">${escapeHTML(news.unit)}</span>` : '';
    const catBadge  = news.category ? `<span class="badge badge--category">${escapeHTML(news.category)}</span>` : '';

    // 画像ギャラリーを構築（image_urls がある場合）
    const imgs = Array.isArray(news.image_urls) ? news.image_urls : [];
    const toEmbed = (u) => {
      try {
        const url = new URL(u, location.origin);
        if (url.hostname.includes('drive.google.com')) {
          // パターン1: /file/d/{id}/view  → uc?export=view&id={id}
          const m = url.pathname.match(/\/file\/d\/([^/]+)\/view/);
          if (m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
          // パターン2: open?id=xxx → uc?export=view&id=xxx
          const id = url.searchParams.get('id');
          if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return url.href;
      } catch { return u; }
    };
    const gallery = imgs.length ? `
      <div class="space-y-4">
        <div>
          <img class="w-full max-h-[60vh] object-cover rounded-xl shadow" src="${toEmbed(imgs[0])}" alt="${escapeHTML(news.title||'')}">
        </div>
        ${imgs.length>1 ? `<div class="grid grid-cols-2 sm:grid-cols-3 gap-3">${imgs.slice(1, 7).map(src=>`
          <a href="${toEmbed(src)}" target="_blank" rel="noopener" class="block">
            <img src="${toEmbed(src)}" alt="${escapeHTML(news.title||'')}" class="w-full h-32 sm:h-36 object-cover rounded-lg border" loading="lazy">
          </a>
        `).join('')}</div>` : ''}
      </div>` : '';

    articleContainer.innerHTML = `
      <article class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2 flex-wrap">${unitBadge}${catBadge}</div>
          <div class="text-sm text-gray-500">${formatDate(news.created_at)}</div>
        </div>
        <h1 class="text-2xl font-bold mb-4">${escapeHTML(news.title || '')}</h1>
        <div class="mb-4 flex flex-wrap">${tagBadges}</div>
        ${gallery}
        <div class="prose max-w-none mt-6">${news.content || ''}</div>
        <div class="mt-8">
          <a href="news-list.html" class="text-green-700 hover:text-green-900 font-semibold">← お知らせ一覧へ戻る</a>
        </div>
      </article>`;
  } catch (err) {
    console.error('Failed to fetch news detail:', err);
    if (articleNotFoundDiv) articleNotFoundDiv.classList.remove('hidden');
    articleContainer.innerHTML = '';
  }
}

